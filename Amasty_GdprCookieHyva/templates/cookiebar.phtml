<?php
/**
 * @author Amasty Team
 * @copyright Copyright (c) Amasty (https://www.amasty.com)
 * @package GDPR Cookie Hyva Compatibility (System)
 */

use Amasty\GdprCookieHyva\ViewModel\CookieBar;
use Amasty\GdprCookieHyva\ViewModel\JsLayout;
use Amasty\GdprCookieHyva\ViewModel\Settings;
use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\Modal;
use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;

/** @var ViewModelRegistry $viewModels */
/** @var Template $block */
/** @var Escaper $escaper */
/** @var Hyva\Theme\ViewModel\HyvaCsp|null $hyvaCsp */

$jsLayout = $viewModels->require(JsLayout::class);
if (!$jsLayout->isCookiePolicyAllowed()) {
    return;
}

$settings = $viewModels->require(Settings::class);
$modalViewModel = $viewModels->require(Modal::class);
$cookieBarViewModel = $viewModels->require(CookieBar::class);

$cookieBarViewModel->setModal($modalViewModel->createModal());
$cookieBarViewModel->setBlock($block->getChildBlock('amasty.cookie.cookiebar.content'));
$cookieBarViewModel->addData($block->getData());
$bar = $cookieBarViewModel->getBar($jsLayout->isAllowCustomersCloseBar());
$barClassList = $cookieBarViewModel->getBarClasses();
?>

<div x-data="initAmastyCookieBar"
     x-bind="eventListeners"
     x-cloak
     id="<?= $escaper->escapeHtmlAttr(CookieBar::REF_NAME) ?>"
    <?php if ($barClassList): ?>
        class="<?= $escaper->escapeHtmlAttr($barClassList) ?>"
    <?php endif; ?>
>
    <?= /** @noEscape */ $bar ?>
</div>

<script data-cfasync="false">
    'use strict';

    function initAmastyCookieBar() {
        return {
            ...hyva.modal({
                duration: 150,
                transitionEnter: 'transform duration-150',
                transitionLeave: 'transform duration-150'
            }),
            eventListeners: {
                ['@close-cookie-bar']() {
                    this.hide('<?= $escaper->escapeHtml($cookieBarViewModel::REF_NAME) ?>');
                },
                ['@open-cookie-bar']() {
                    Alpine.store('AmastyCookieGroups').updateGroupData(false, true); // Force update when opening
                    this.show('<?= $escaper->escapeHtml($cookieBarViewModel::REF_NAME) ?>');
                    this.$nextTick(() => hyva.trapFocus(this.modalElement));
                },
                ['@amasty-cookie-group-updated.window']() {
                    const lastUpdate = Alpine.store('AmastyCookieGroups').lastUpdate;
                    if (this.isShowNotificationBar(this.firstShowProcess, lastUpdate)) {
                        !this.opened['<?= $escaper->escapeHtml($cookieBarViewModel::REF_NAME) ?>'] &&
                        this.show('<?= $escaper->escapeHtml($cookieBarViewModel::REF_NAME) ?>');
                        this.$nextTick(() => hyva.trapFocus(this.modalElement));
                    } else {
                        !!this.opened['<?= $escaper->escapeHtml($cookieBarViewModel::REF_NAME) ?>'] &&
                        this.hide('<?= $escaper->escapeHtml($cookieBarViewModel::REF_NAME) ?>');
                    }
                }
            },

            firstShowProcess: '<?= $escaper->escapeHtml($settings->getFirstShowProcess()) ?>',

            /**
             * @returns {void}
             */
            init: function () {
                window.isGdprCookieEnabled = true;
                // Removed direct call to updateGroupData here. It will be called when the bar is opened.
                this.modalElement = this.$refs['<?= $escaper->escapeHtml($cookieBarViewModel::REF_NAME) ?>'];
                this.modalElement.setAttribute('aria-describedby', 'amcookie-bar-content');
            },

            /**
             * @param {string|number} firstShowProcess
             * @param {number} lastUpdate
             * @returns {boolean}
             */
            isShowNotificationBar: function (firstShowProcess, lastUpdate) {
                return (this.isNeedFirstShow(firstShowProcess, lastUpdate) && !hyva.getCookie('amcookie_allowed')
                    || this.isNeedShowOnUpdate(lastUpdate));
            },

            /**
             * @param {string|number} firstShowProcess
             * @param {number} lastUpdate
             * @returns {boolean}
             */
            isNeedFirstShow: function (firstShowProcess, lastUpdate) {
                hyva.getBrowserStorage().setItem('amCookieBarFirstShowTime', lastUpdate);

                if (firstShowProcess === '0') {
                    return true;
                }

                if (hyva.getBrowserStorage().getItem('amCookieBarFirstShow') !== '1') {
                    hyva.getBrowserStorage().setItem('amCookieBarFirstShow', '1');

                    return true;
                }

                return false;
            },

            /**
             * @param {number} lastUpdate
             * @returns {boolean}
             */
            isNeedShowOnUpdate: function (lastUpdate) {
                if (!lastUpdate) {
                    return false;
                }

                return this.isNeedShowAfterLastVisit(lastUpdate) || this.isNeedShowAfterLastAccept(lastUpdate);
            },

            /**
             * @param {number} lastUpdate
             * @returns {boolean}
             */
            isNeedShowAfterLastVisit: function (lastUpdate) {
                let needToShowAfterLastVisit =
                    lastUpdate > hyva.getBrowserStorage().getItem('amCookieBarFirstShowTime');

                if (needToShowAfterLastVisit) {
                    hyva.getBrowserStorage().setItem('amCookieBarFirstShow', null);
                    hyva.setCookie('amcookie_allowed', '', -1, true);
                }

                return needToShowAfterLastVisit;
            },

            /**
             * @param {number} lastUpdate
             * @returns {boolean}
             */
            isNeedShowAfterLastAccept: function (lastUpdate) {
                let needToShowAfterLastAccept = false;

                if (hyva.getBrowserStorage().getItem('am-last-cookie-acceptance')) {
                    needToShowAfterLastAccept =
                        lastUpdate > hyva.getBrowserStorage().getItem('am-last-cookie-acceptance');
                }

                return needToShowAfterLastAccept;
            },

            /**
             * @returns {void}
             */
            closeCookieBarHandler: function () {
                this.$dispatch('close-cookie-bar');
            }
        };
    }

    window.addEventListener('alpine:init', () => Alpine.data('initAmastyCookieBar', initAmastyCookieBar), {once: true});
</script>
<?php isset($hyvaCsp) && $hyvaCsp->registerInlineScript() ?>
