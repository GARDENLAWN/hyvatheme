<?php
/**
 * @author Amasty Team
 * @copyright Copyright (c) Amasty (https://www.amasty.com)
 * @package Live Chat for Magento 2
 */
/** @var \Amasty\MessengerWidget\Block\Messenger\Widget $block */
/** @var \Magento\Framework\Escaper $escaper */

if (!$block->isShowMessengers()) {
    return;
}

$jsLayout = $block->getJsLayout();
$config = json_decode($jsLayout, true);
$componentConfig = $config['components']['ammessenger-widget'] ?? [];
$messengers = $componentConfig['messengers'] ?? [];
$position = $componentConfig['widgetPosition'] ?? 'bottom-right';
$privacyConfig = $componentConfig['children']['ammessenger-privacy-policy'] ?? [];
$isPrivacyEnabled = isset($privacyConfig['isPrivacyPolicyEnabled']) && $privacyConfig['isPrivacyPolicyEnabled'];

// Map position to CSS classes
$positionClasses = [
    'top-left' => '-top -left',
    'top-right' => '-top -right',
    'center-left' => '-center -left',
    'center-right' => '-center -right',
    'bottom-left' => '-bottom -left',
    'bottom-right' => '-bottom -right',
];
$positionClass = $positionClasses[$position] ?? '-bottom -right';

// Icons
$chatIcon = $block->getViewFileUrl('Amasty_MessengerWidget::images/icons/chat.svg');
$chatIconHover = $block->getViewFileUrl('Amasty_MessengerWidget::images/icons/chat_hover.svg');
$chatIconActive = $block->getViewFileUrl('Amasty_MessengerWidget::images/icons/chat_active.svg');
$closeIcon = $block->getViewFileUrl('Amasty_MessengerWidget::images/icons/close.svg');
$closeIconHover = $block->getViewFileUrl('Amasty_MessengerWidget::images/icons/close_hover.svg');
$closeIconActive = $block->getViewFileUrl('Amasty_MessengerWidget::images/icons/close_active.svg');
?>

<script>
    function initAmastyMessenger() {
        return {
            opened: false,
            chatOpen: false,
            chatMessage: '',
            activeMessenger: null,
            messengers: <?= json_encode($messengers) ?>,
            position: '<?= $escaper->escapeJs($position) ?>',
            isPrivacyEnabled: <?= $isPrivacyEnabled ? 'true' : 'false' ?>,
            privacyAccepted: false,
            icons: {
                chat: '<?= $escaper->escapeUrl($chatIcon) ?>',
                chatHover: '<?= $escaper->escapeUrl($chatIconHover) ?>',
                chatActive: '<?= $escaper->escapeUrl($chatIconActive) ?>',
                close: '<?= $escaper->escapeUrl($closeIcon) ?>',
                closeHover: '<?= $escaper->escapeUrl($closeIconHover) ?>',
                closeActive: '<?= $escaper->escapeUrl($closeIconActive) ?>'
            },
            hover: false,
            active: false,

            init() {
                // Check local storage for privacy acceptance if needed
            },

            toggle() {
                this.opened = !this.opened;
                if (!this.opened) {
                    this.chatOpen = false;
                }
            },

            handleMessengerClick(messenger, event) {
                // Privacy Check
                if (this.isPrivacyEnabled && !this.privacyAccepted) {
                    event.preventDefault();
                    alert('Privacy Policy acceptance required');
                    return;
                }

                // Check if it is WhatsApp (by link content)
                if (messenger.link.includes('wa.me') || messenger.link.includes('whatsapp.com')) {
                    event.preventDefault();
                    this.activeMessenger = messenger;
                    this.chatOpen = true;
                    this.opened = false; // Close the list if it was open

                    // Focus textarea
                    this.$nextTick(() => {
                        if (this.$refs.chatInput) {
                            this.$refs.chatInput.focus();
                        }
                    });
                }
                // If not WhatsApp, let the default link behavior happen
            },

            closeChat() {
                this.chatOpen = false;
                this.chatMessage = '';
            },

            sendWhatsApp() {
                if (!this.activeMessenger) return;

                let url = this.activeMessenger.link;
                if (this.chatMessage.trim().length > 0) {
                    // Check if link already has query params
                    const separator = url.includes('?') ? '&' : '?';
                    url += separator + 'text=' + encodeURIComponent(this.chatMessage);
                }

                window.open(url, '_blank');
                this.closeChat();
            },

            get componentClasses() {
                let classes = '';
                if (this.opened) {
                    classes += ' -opened';
                }
                classes += ' -items-' + Math.min(this.messengers.length, 5);

                if (this.messengers.length > 5 || this.position.includes('center')) {
                    classes += ' -drop-line';
                } else {
                    classes += ' -drop-circle';
                }

                return classes;
            },

            get toggleIconSrc() {
                if (this.opened) {
                    if (this.active) return this.icons.closeActive;
                    if (this.hover) return this.icons.closeHover;
                    return this.icons.close;
                } else {
                    if (this.active) return this.icons.chatActive;
                    if (this.hover) return this.icons.chatHover;
                    return this.icons.chat;
                }
            },

            get chatWindowPositionClass() {
                // Mobile: always fixed bottom/center
                // Desktop: relative to widget position

                let base = 'fixed sm:absolute z-50 ';

                // Mobile positioning (fixed bottom sheet style or centered popup)
                // We'll use a centered approach for mobile that sits above the widget
                base += 'bottom-[100px] left-1/2 -translate-x-1/2 sm:translate-x-0 sm:left-auto sm:bottom-full sm:mb-4 ';

                if (this.position.includes('left')) {
                    base += 'sm:left-0 sm:right-auto ';
                } else {
                    base += 'sm:right-0 sm:left-auto ';
                }

                if (this.position.includes('top')) {
                    // Override for top position on desktop
                    base = base.replace('sm:bottom-full', 'sm:top-full').replace('sm:mb-4', 'sm:mt-4');
                }

                return base;
            }
        }
    }
</script>

<div x-data="initAmastyMessenger()" class="ammessenger-widget-container <?= $positionClass ?>">

    <!-- Chat Window Popup -->
    <div x-show="chatOpen"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 transform scale-90 translate-y-2"
         x-transition:enter-end="opacity-100 transform scale-100 translate-y-0"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100 transform scale-100 translate-y-0"
         x-transition:leave-end="opacity-0 transform scale-90 translate-y-2"
         @click.outside="closeChat()"
         class="bg-white rounded-lg shadow-2xl overflow-hidden flex flex-col border border-gray-100 w-[90vw] max-w-[380px] sm:w-[380px]"
         :class="chatWindowPositionClass"
         style="display: none;"
         x-bind:style="chatOpen ? 'display: flex;' : 'display: none;'">

        <!-- Header -->
        <div class="bg-[#075e54] p-4 text-white flex justify-between items-center shadow-sm">
            <div class="flex items-center gap-3">
                <div class="relative">
                    <img :src="activeMessenger?.image_src[0]" class="w-12 h-12 rounded-full bg-white p-1 object-cover">
                    <div class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-400 rounded-full border-2 border-[#075e54]"></div>
                </div>
                <div class="flex flex-col">
                    <span class="font-bold text-base leading-tight" x-text="activeMessenger?.title || 'WhatsApp'"></span>
                    <span class="text-xs text-green-100 opacity-90">Zazwyczaj odpisuje w ciÄ…gu godziny</span>
                </div>
            </div>
            <button @click="closeChat()" class="hover:bg-white/10 rounded-full p-2 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <!-- Body -->
        <div class="p-4 bg-[#e5ddd5] flex-grow relative min-h-[200px]">
            <!-- Background pattern opacity -->
            <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-size: 400px;"></div>

            <div class="relative bg-white p-3.5 rounded-lg rounded-tl-none shadow-sm mb-4 inline-block max-w-[85%]">
                <p class="text-sm text-gray-800 leading-relaxed">CzeÅ›Ä‡! ðŸ‘‹<br>W czym moÅ¼emy Ci pomÃ³c?</p>
                <span class="text-[10px] text-gray-400 block text-right mt-1" x-text="new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})"></span>
            </div>

            <div class="relative z-10">
                <textarea x-ref="chatInput"
                          x-model="chatMessage"
                          @keydown.enter.prevent="sendWhatsApp()"
                          class="w-full p-3 border-0 rounded-lg shadow-sm focus:ring-2 focus:ring-[#25D366] outline-none text-sm resize-none"
                          rows="3"
                          placeholder="Wpisz wiadomoÅ›Ä‡..."></textarea>
            </div>
        </div>

        <!-- Footer -->
        <div class="p-4 bg-[#f0f0f0] border-t border-gray-200 flex justify-end items-center gap-2">
            <button @click="sendWhatsApp()"
                    class="bg-[#25D366] hover:bg-[#128c7e] text-white px-6 py-2.5 rounded-full text-sm font-bold flex items-center gap-2 transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5 w-full justify-center sm:w-auto">
                <span>Rozpocznij czat</span>
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
            </button>
        </div>
    </div>

    <div class="ammessenger-widget-component" :class="componentClasses">

        <!-- Single Messenger -->
        <template x-if="messengers.length === 1">
            <a class="ammessenger-item -single"
               :href="messengers[0].link"
               :title="messengers[0].tooltip"
               :aria-label="messengers[0].title"
               @click="handleMessengerClick(messengers[0], $event)"
               target="_blank"
               style="display: block;">
                <img class="ammessenger-icon"
                     :src="messengers[0].image_src[0]"
                     :srcset="messengers[0].image_src.length > 1 ? messengers[0].image_src[1] + ' 2x' : ''"
                     :alt="messengers[0].tooltip">
            </a>
        </template>

        <!-- Multiple Messengers -->
        <template x-if="messengers.length > 1">
            <div class="w-full h-full">
                <div class="ammessenger-toggle"
                      @click="toggle()"
                      @mouseenter="hover = true"
                      @mouseleave="hover = false"
                      @mousedown="active = true"
                      @mouseup="active = false"
                      :class="{ '-opened': opened }">
                     <img :src="toggleIconSrc" alt="Toggle Chat" class="w-full h-full object-contain">
                </div>

                <div class="ammessenger-messengers-container">
                    <template x-for="(messenger, index) in messengers" :key="index">
                        <a class="ammessenger-item"
                           :href="messenger.link"
                           :title="messenger.tooltip"
                           :aria-label="messenger.title"
                           @click="handleMessengerClick(messenger, $event)"
                           target="_blank">
                            <img class="ammessenger-icon"
                                 :src="messenger.image_src[0]"
                                 :srcset="messenger.image_src.length > 1 ? messenger.image_src[1] + ' 2x' : ''"
                                 :alt="messenger.title">
                        </a>
                    </template>
                </div>
            </div>
        </template>

    </div>
</div>
