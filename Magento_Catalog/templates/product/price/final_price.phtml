<?php
/**
 * Hyvä Themes - https://hyva.io
 * Copyright © Hyvä Themes. All rights reserved.
 * See COPYING.txt for license details.
 */

use Magento\Catalog\Pricing\Price\FinalPrice;
use Magento\Catalog\Pricing\Price\RegularPrice;
use Magento\Catalog\Pricing\Price\TierPrice;
use Magento\Framework\Pricing\Render;
use Magento\Framework\Pricing\Render\PriceBox;

/** @var PriceBox $block */

/** @var FinalPrice $finalPriceModel */
$finalPriceModel = $block->getPrice();
$priceId = $block->getPriceId();
$productId = $finalPriceModel->getProduct()->getId();

$idSuffix = $block->getIdSuffix() ? $block->getIdSuffix() : '';
$htmlPriceId = 'product-price-' . $productId . $idSuffix;

// Regular Price (Old Price)
/** @var RegularPrice $regularPriceModel */
$regularPriceModel = $finalPriceModel->getProduct()->getPriceInfo()->getPrice(RegularPrice::PRICE_CODE);

// Use Base Amount
$regularPriceBase = $regularPriceModel->getAmount()->getBaseAmount();
$finalPriceBase = $finalPriceModel->getAmount()->getBaseAmount();

// For discount check
$regularPriceVal = $regularPriceModel->getAmount()->getValue();
$finalPriceVal = $finalPriceModel->getAmount()->getValue();
$hasDiscount = $regularPriceVal > $finalPriceVal;

// Check for Tier Prices (As Low As)
$product = $finalPriceModel->getProduct();
$tierPriceModel = $product->getPriceInfo()->getPrice(TierPrice::PRICE_CODE);
$minTierPriceBase = null;
$showAsLowAs = false;

if ($tierPriceModel->getTierPriceList()) {
    foreach ($tierPriceModel->getTierPriceList() as $tier) {
        $tierValBase = $tier['price']->getBaseAmount();
        if ($minTierPriceBase === null || $tierValBase < $minTierPriceBase) {
            $minTierPriceBase = $tierValBase;
        }
    }

    if ($minTierPriceBase !== null && $minTierPriceBase < $finalPriceBase) {
        $finalPriceBase = $minTierPriceBase; // Use tier price as main price
        $showAsLowAs = true;
        $hasDiscount = false; // Don't show old price if showing "As low as" (usually)
    }
}

// Tax Logic
$catalogHelper = $this->helper(Magento\Catalog\Helper\Data::class);
$priceHelper = $this->helper(Magento\Framework\Pricing\Helper\Data::class);

// Initial values (PHP side)
$finalPriceIncl = $catalogHelper->getTaxPrice($product, $finalPriceBase, true);
$finalPriceExcl = $catalogHelper->getTaxPrice($product, $finalPriceBase, false);
$regularPriceIncl = $catalogHelper->getTaxPrice($product, $regularPriceBase, true);
$regularPriceExcl = $catalogHelper->getTaxPrice($product, $regularPriceBase, false);

$showNet = $finalPriceIncl != $finalPriceExcl;

// Determine context (List vs View)
$isListing = $block->getZone() !== Render::ZONE_ITEM_VIEW;

// Styles based on context
$containerClass = $isListing ? 'items-start' : 'items-end';
$grossClass = $isListing ? 'text-2xl' : 'text-4xl';
$netClass = $isListing ? 'text-xs' : 'text-sm';

?>
<script>
    function initPrice<?= (int)$productId ?>() {
        return {
            regularPriceKey: 'oldPrice',
            finalPriceKey: 'finalPrice',
            activeProductsPriceData: false,
            initialFinalPrice: <?= (float)$finalPriceIncl ?>,
            initialBasePrice: <?= (float)$finalPriceExcl ?>,
            calculatedFinalPrice: false,
            calculatedBasePrice: false,
            qty: 1,
            customOptionPrices: [],

            getFormattedFinalPrice() {
                return hyva.formatPrice(this.calculatedFinalPrice || this.initialFinalPrice);
            },
            getFormattedBasePrice() {
                return hyva.formatPrice(this.calculatedBasePrice || this.initialBasePrice);
            },
            formatOldPrice() {
                return hyva.formatPrice(<?= (float)$regularPriceIncl ?>);
            },

            eventListeners: {
                ['@update-prices-<?= (int)$productId ?>.window'](event) {
                    this.activeProductsPriceData = event.detail;
                    if (event.detail && event.detail.finalPrice) {
                        this.calculatedFinalPrice = event.detail.finalPrice.amount;
                        this.calculatedBasePrice = event.detail.basePrice.amount;
                    }
                },
                ['@update-qty-<?= (int)$productId ?>.window'](event) {
                    this.qty = event.detail;
                }
            }
        }
    }
    window.addEventListener('alpine:init', () => Alpine.data('initPrice<?= (int)$productId ?>', initPrice<?= (int)$productId ?>), {once: true})
</script>

<div x-data="initPrice<?= (int)$productId ?>" x-bind="eventListeners" class="price-box price-final_price flex flex-col <?= $containerClass ?>">

    <!-- Old Price -->
    <?php if ($hasDiscount): ?>
        <div class="old-price text-gray-400 line-through text-sm mb-0.5">
            <span class="price-wrapper">
                <span class="price" x-html="formatOldPrice"><?= $priceHelper->currency($regularPriceIncl, true, false) ?></span>
            </span>
        </div>
    <?php endif; ?>

    <!-- Final Price (Gross) -->
    <div class="final-price font-extrabold text-gray-900 <?= $grossClass ?> leading-none tracking-tight">
        <?php if ($showAsLowAs): ?>
            <span class="text-xs text-gray-500 font-normal mr-1"><?= $block->escapeHtml(__('As low as')) ?></span>
        <?php endif; ?>
        <span id="<?= $htmlPriceId ?>" class="price-wrapper">
            <span class="price" x-html="getFormattedFinalPrice"><?= $priceHelper->currency($finalPriceIncl, true, false) ?></span>
        </span>
    </div>

    <!-- Net Price -->
    <?php if ($showNet): ?>
        <div class="final-price-excl-tax text-gray-500 <?= $netClass ?> mt-1 font-medium">
            <span class="price-wrapper">
                <span class="price" x-html="getFormattedBasePrice"><?= $priceHelper->currency($finalPriceExcl, true, false) ?></span>
                <span><?= $block->escapeHtml(__('netto')) ?></span>
            </span>
        </div>
    <?php endif; ?>
</div>
