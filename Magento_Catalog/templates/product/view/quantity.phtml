<?php
/**
 * Hyvä Themes - https://hyva.io
 * Copyright © Hyvä Themes. All rights reserved.
 * See COPYING.txt for license details.
 */

declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\HyvaCsp;
use Hyva\Theme\ViewModel\ProductStockItem;
use Magento\Catalog\Block\Product\View;
use Magento\Catalog\Model\Product;
use Magento\Framework\Escaper;

// phpcs:disable Generic.WhiteSpace.ScopeIndent.Incorrect

/** @var View $block */
/** @var Escaper $escaper */
/** @var HyvaCsp $hyvaCsp */
/** @var ViewModelRegistry $viewModels */

/** @var Product $product */
$product = $block->getProduct();

/** @var ProductStockItem $stockItemViewModel */
$stockItemViewModel = $viewModels->require(ProductStockItem::class);
$minSalesQty = $stockItemViewModel->getMinSaleQty($product);
$maxSalesQty = $stockItemViewModel->getMaxSaleQty($product);
$defaultQty = $block->getProductDefaultQty() * 1;

$step = $stockItemViewModel->getQtyIncrements($product)
    ? $stockItemViewModel->getQtyIncrements($product)
    : 1;

/**
 * sets minimum and maximum values taking into account the values set in the admin,
 * but taking into account the value of Qty Increments
 */
if ($step > 1) {
    $minSalesQty = ceil($minSalesQty / $step) * $step;
    $maxSalesQty = floor($maxSalesQty / $step) * $step;
    $defaultQty = ceil($defaultQty / $step) * $step;
}

$maxSalesQtyLength = ($maxSalesQty ? strlen((string) $maxSalesQty) : 4)
    + (/* add one if decimal for separator */ (int) $stockItemViewModel->isQtyDecimal($product));


?>
<?php if ($block->shouldRenderQuantity()): ?>
    <script>
        function initQtyField() {

            function findPathParam(key) {
                // get all path pairs after BASE_URL/front_name/action_path/action
                const baseUrl = (BASE_URL.substring(0, 2) === '//' ? 'http:' : '') + BASE_URL;
                const baseUrlParts = (new URL(baseUrl)).pathname.replace(/\/$/, '').split('/');
                const pathParts = window.location.pathname.split('/').slice(baseUrlParts.length + 3);
                for (let i = 0; i < pathParts.length; i += 2) {
                    if (pathParts[i] === key && pathParts.length > i) {
                        return pathParts[i + 1];
                    }
                }
            }

            return {
                qty: <?= /** @noEscape */ $defaultQty ?>,
                itemId: (new URLSearchParams(window.location.search)).get('id') || findPathParam('id'),
                productId: '<?= (int)$product->getId() ?>',
                step: <?= (float)$step ?>,
                minQty: <?= (float)($minSalesQty ?: 1) ?>,
                maxQty: <?= (float)($maxSalesQty ?: 10000) ?>,
                init() {
                    this.$dispatch('update-qty-<?= (int)$product->getId() ?>', this.qty);
                },
                <?php /* populate the qty when editing a product from the cart */ ?>
                onGetCartData() {
                    const data = this.$event.detail.data;
                    const cart = data && data.data && data.data.cart;
                    if (this.itemId && cart && cart.items) {
                        const cartItem = cart.items.find((item) => {
                            return item.item_id === this.itemId && item.product_id === this.productId;
                        });
                        if (cartItem && cartItem.qty) {
                            this.qty = cartItem.qty;
                            this.$dispatch('update-qty-' + this.productId, this.qty);
                        }
                    }
                },
                updateQty() {
                    this.$dispatch('update-qty-<?= (int)$product->getId() ?>', this.qty);
                },
                onInput(event) {
                    this.qty = hyva.safeParseNumber(event.target.value);
                    this.updateQty();
                },
                increment() {
                    if (this.qty < this.maxQty) {
                        this.qty += this.step;
                        this.updateQty();
                    }
                },
                decrement() {
                    if (this.qty > this.minQty) {
                        this.qty -= this.step;
                        this.updateQty();
                    }
                },
                onConfigurableSelectionChanged(event) {
                    // Check if the selection is complete (all options selected)
                    // The event detail usually contains the product candidates.
                    // If candidates length is 1, it means a specific simple product is selected.
                    const candidates = event.detail.candidates;
                    if (candidates && candidates.length === 1) {
                         if (this.qty === 0 || !this.qty) {
                            this.qty = this.minQty;
                            this.updateQty();
                        }
                    }
                }
            };
        }
        window.addEventListener('alpine:init', () => Alpine.data('initQtyField', initQtyField), {once: true})
    </script>
    <?php $hyvaCsp->registerInlineScript() ?>
    <div x-data="initQtyField"
         @configurable-selection-changed.window="onConfigurableSelectionChanged($event)"
         class="mr-2"
    >
        <?php if ($product->isSaleable()): ?>
            <label for="qty[<?= (int)$product->getId() ?>]" class="sr-only">
                <?= $escaper->escapeHtml(__('Quantity')) ?>
            </label>
            <div class="flex items-center border border-gray-300 rounded-md overflow-hidden w-40">
                <style>
                    /* Hide number input arrows */
                    input[type=number]::-webkit-inner-spin-button,
                    input[type=number]::-webkit-outer-spin-button {
                        -webkit-appearance: none;
                        margin: 0;
                    }
                    input[type=number] {
                        -moz-appearance: textfield;
                    }
                </style>
                <button type="button"
                        @click="decrement"
                        class="px-3 py-2 bg-gray-50 text-gray-600 hover:bg-gray-100 border-r border-gray-300 focus:outline-none transition-colors"
                        :class="{'opacity-50 cursor-not-allowed': qty <= minQty}"
                        :disabled="qty <= minQty"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                    </svg>
                </button>

                <input name="qty"
                    @private-content-loaded.window="onGetCartData"
                    id="qty[<?= (int)$product->getId() ?>]"
                    form="product_addtocart_form"
                    <?php if ($stockItemViewModel->isQtyDecimal($product)): ?>
                    type="text"
                    pattern="[0-9]+(\.[0-9]{1,<?= /** @noEscape */ $maxSalesQtyLength ?>})?"
                    inputmode="decimal"
                    <?php else: ?>
                    type="number"
                    pattern="[0-9]{0,<?= /** @noEscape */ $maxSalesQtyLength ?>}"
                    inputmode="numeric"
                    <?php if ($minSalesQty): ?>min="<?= /** @noEscape */ $minSalesQty ?>"<?php endif; ?>
                    <?php if ($maxSalesQty): ?>max="<?= /** @noEscape */ $maxSalesQty ?>"<?php endif; ?>
                    <?php if ($step): ?>step="<?= /** @noEscape */ $step ?>"<?php endif; ?>
                    <?php endif; ?>
                    x-model="qty"
                    class="form-input px-2 py-2 w-full text-center border-none focus:ring-0 text-gray-900 font-medium appearance-none"
                    @input="onInput"
                >

                <button type="button"
                        @click="increment"
                        class="px-3 py-2 bg-gray-50 text-gray-600 hover:bg-gray-100 border-l border-gray-300 focus:outline-none transition-colors"
                        :class="{'opacity-50 cursor-not-allowed': qty >= maxQty}"
                        :disabled="qty >= maxQty"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                </button>
            </div>
        <?php endif; ?>
    </div>
<?php endif; ?>
