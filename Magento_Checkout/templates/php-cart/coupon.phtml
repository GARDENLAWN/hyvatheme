<?php
/**
 * Hyvä Themes - https://hyva.io
 * Copyright © Hyvä Themes. All rights reserved.
 * See COPYING.txt for license details.
 */

declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\LucideIcons;
use Magento\Checkout\Block\Cart\Coupon;
use Magento\Framework\Escaper;

/** @var Coupon $block */
/** @var Escaper $escaper */
/** @var ViewModelRegistry $viewModels */

/** @var LucideIcons $lucideIcons */
$lucideIcons = $viewModels->require(LucideIcons::class);
?>
<script>
    if (typeof initCouponForm === 'undefined') {
        function initCouponForm() {
            return {
                errors: 0,
                hasCaptchaToken: 0,
                showCouponForm: true, // Default to true
                isLoading: false,
                hideCouponForm() {
                    return ! this.showCouponForm;
                },
                formData: {
                    coupon_code: '',
                    remove: '0'
                },
                eventListeners: {
                    ['@update-totals-start.window']() {
                        this.isLoading = true;
                    },
                    ['@update-totals-end.window']() {
                        this.isLoading = false;
                    }
                },
                init(){
                    const browserStorageShowCouponForm = hyva.getBrowserStorage().getItem('hyva.showCouponForm');
                    // Default to true if not set
                    this.showCouponForm = browserStorageShowCouponForm === null ? true : (browserStorageShowCouponForm === 'true');

                    this.formData.coupon_code = '<?= $escaper->escapeJs($block->getCouponCode()) ?>';
                    this.formData.remove = '<?= $escaper->escapeJs($block->getCouponCode() ? '1' : '0') ?>';
                },
                toggleShowCoupon() {
                    this.showCouponForm = !this.showCouponForm;

                    hyva.getBrowserStorage().setItem('hyva.showCouponForm', this.showCouponForm);

                    this.$nextTick(() => this.$refs.couponInput.select());
                },
                onInput() {
                    this.formData.coupon_code = this.$event.target.value;
                },
                submitForm() {
                    const $form = document.querySelector('#discount-coupon-form');

                    if (this.errors === 0) {
                        hyva.postCart($form);
                    }
                }
            };
        };
    }

    window.addEventListener('alpine:init', () => {
        Alpine.data('initCouponForm', initCouponForm)
    }, { once: true });
</script>

<div id="block-coupon" class="coupon-form bg-gray-50 p-4 rounded-xl border border-gray-100 relative" x-data="initCouponForm" x-bind="eventListeners">
    <template x-if="isLoading">
        <div class="z-10 absolute inset-0 flex items-center justify-center bg-white/60 rounded-lg">
            <svg class="animate-spin h-8 w-8 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>
    </template>
    <form id="discount-coupon-form"
          action="<?= $escaper->escapeUrl($block->getUrl('checkout/cart/couponPost')) ?>"
          method="post"
          @submit.prevent="submitForm"
    >
        <?= $block->getBlockHtml('formkey') ?>
        <label for="coupon_code" class="flex items-center gap-2 text-sm font-bold text-gray-700 mb-3">
            <?= $lucideIcons->ticketHtml('text-primary', 20, 20, ['aria-hidden' => 'true']) ?>
            <?= $escaper->escapeHtml(__('Discount Code')) ?>
        </label>
        <div class="fieldset coupon flex gap-2">
            <div class="control grow relative">
                <input type="text"
                       id="coupon_code"
                       name="coupon_code"
                       class="form-input w-full border-gray-300 rounded-lg focus:ring-primary focus:border-primary bg-white shadow-sm placeholder-gray-400 text-sm py-2.5"
                       value="<?= $escaper->escapeHtmlAttr($block->getCouponCode()) ?>"
                       @input="onInput"
                       x-ref="couponInput"
                       placeholder="<?= $escaper->escapeHtmlAttr(__('Enter discount code')) ?>"
                       <?php if ($block->getCouponCode()): ?>disabled="disabled"<?php endif; ?>
                       required
                />
            </div>
            <?php if (!$block->getCouponCode()): ?>
                <button class="btn btn-primary shrink-0 rounded-lg px-5 py-2.5 text-sm font-semibold shadow-sm hover:shadow transition-all" type="submit" value="<?= $escaper->escapeHtmlAttr(__('Apply Discount')) ?>">
                    <?= $escaper->escapeHtml(__('Apply')) ?>
                </button>
            <?php else: ?>
                <button  type="button" class="btn btn-secondary shrink-0 rounded-lg px-5 py-2.5 text-sm font-semibold shadow-sm hover:shadow transition-all text-red-600 hover:text-red-700 bg-white border-gray-200" @click="formData.remove='1'; submitForm()" value="<?= $escaper->escapeHtmlAttr(__('Cancel Coupon')) ?>">
                    <?= $escaper->escapeHtml(__('Cancel')) ?>
                </button>
            <?php endif; ?>
            <?php if ($block->getCouponCode()): ?>
                <input type="hidden" name="remove" :value="formData.remove" />
            <?php endif; ?>
        </div>
    </form>
</div>
