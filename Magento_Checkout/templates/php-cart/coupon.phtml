<?php
/**
 * Hyvä Themes - https://hyva.io
 * Copyright © Hyvä Themes. All rights reserved.
 * See COPYING.txt for license details.
 */

declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\LucideIcons;
use Magento\Checkout\Block\Cart\Coupon;
use Magento\Framework\Escaper;

/** @var Coupon $block */
/** @var Escaper $escaper */
/** @var ViewModelRegistry $viewModels */

/** @var LucideIcons $lucideIcons */
$lucideIcons = $viewModels->require(LucideIcons::class);
?>
<script>
    function initCouponForm() {
        return {
            errors: 0,
            hasCaptchaToken: 0,
            showCouponForm: true, // Default to true
            hideCouponForm() {
                return ! this.showCouponForm;
            },
            formData: {
                coupon_code: '',
                remove: '0'
            },
            init(){
                const browserStorageShowCouponForm = hyva.getBrowserStorage().getItem('hyva.showCouponForm');
                // Default to true if not set
                this.showCouponForm = browserStorageShowCouponForm === null ? true : (browserStorageShowCouponForm === 'true');

                this.formData.coupon_code = '<?= $escaper->escapeJs($block->getCouponCode()) ?>';
                this.formData.remove = '<?= $escaper->escapeJs($block->getCouponCode() ? '1' : '0') ?>';
            },
            toggleShowCoupon() {
                this.showCouponForm = !this.showCouponForm;

                hyva.getBrowserStorage().setItem('hyva.showCouponForm', this.showCouponForm);

                this.$nextTick(() => this.$refs.couponInput.select());
            },
            onInput() {
                this.formData.coupon_code = this.$event.target.value;
            },
            submitForm() {
                const $form = document.querySelector('#discount-coupon-form');

                if (this.errors === 0) {
                    hyva.postCart($form);
                }
            }
        };
    };

    window.addEventListener('alpine:init', () => {
        Alpine.data('initCouponForm', initCouponForm)
    }, { once: true });
</script>

<div class="coupon-form" x-data="initCouponForm">
    <form id="discount-coupon-form"
          action="<?= $escaper->escapeUrl($block->getUrl('checkout/cart/couponPost')) ?>"
          method="post"
          @submit.prevent="submitForm"
    >
        <?= $block->getBlockHtml('formkey') ?>
        <label for="coupon_code" class="block text-sm font-medium text-gray-700 mb-2">
            <?= $escaper->escapeHtml(__('Discount Code')) ?>
        </label>
        <div class="fieldset coupon flex gap-2">
            <div class="control grow relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <?= $lucideIcons->tagHtml('text-gray-400', 18, 18, ['aria-hidden' => 'true']) ?>
                </div>
                <input type="text"
                       id="coupon_code"
                       name="coupon_code"
                       class="form-input w-full pl-10 border-gray-300 rounded-lg focus:ring-primary focus:border-primary"
                       value="<?= $escaper->escapeHtmlAttr($block->getCouponCode()) ?>"
                       @input="onInput"
                       x-ref="couponInput"
                       placeholder="<?= $escaper->escapeHtmlAttr(__('Enter discount code')) ?>"
                       <?php if ($block->getCouponCode()): ?>disabled="disabled"<?php endif; ?>
                       required
                />
            </div>
            <?php if (!$block->getCouponCode()): ?>
                <button class="btn btn-primary shrink-0 rounded-lg px-6" type="submit" value="<?= $escaper->escapeHtmlAttr(__('Apply Discount')) ?>">
                    <?= $escaper->escapeHtml(__('Apply')) ?>
                </button>
            <?php else: ?>
                <button  type="button" class="btn btn-secondary shrink-0 rounded-lg px-6" @click="formData.remove='1'; submitForm()" value="<?= $escaper->escapeHtmlAttr(__('Cancel Coupon')) ?>">
                    <?= $escaper->escapeHtml(__('Cancel')) ?>
                </button>
            <?php endif; ?>
            <?php if ($block->getCouponCode()): ?>
                <input type="hidden" name="remove" :value="formData.remove" />
            <?php endif; ?>
        </div>
    </form>
</div>
