<?php
/**
 * Hyvä Themes - https://hyva.io
 * Copyright © Hyvä Themes. All rights reserved.
 * See COPYING.txt for license details.
 */

declare(strict_types=1);

// phpcs:disable Generic.WhiteSpace.ScopeIndent
// phpcs:disable Magento2.Files.LineLength.MaxExceeded

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\ProductStockItem;
use Hyva\Theme\ViewModel\LucideIcons;
use Magento\Checkout\Block\Cart\Item\Renderer;
use Magento\Framework\Escaper;

/** @var Renderer $block */
/** @var Escaper $escaper */
/** @var ViewModelRegistry $viewModels */

/** @var ProductStockItem $stockItemViewModel */
$stockItemViewModel = $viewModels->require(ProductStockItem::class);

/** @var LucideIcons $lucideIcons */
$lucideIcons = $viewModels->require(LucideIcons::class);

$item = $block->getItem();
$product = $item->getProduct();
$isVisibleProduct = $product->isVisibleInSiteVisibility();

$minSalesQty = $stockItemViewModel->getMinSaleQty($product);
$maxSalesQty = $stockItemViewModel->getMaxSaleQty($product);
$qty = $stockItemViewModel->isQtyDecimal($product)
    ? $block->getQty()
    : (int) $block->getQty();

$step = $stockItemViewModel->getQtyIncrements($product)
    ? $stockItemViewModel->getQtyIncrements($product)
    : 1;

/**
 * sets minimum and maximum values taking into account the values set in the admin,
 * but taking into account the value of Qty Increments
 */
if ($step > 1) {
    $minSalesQty = ceil($minSalesQty / $step) * $step;
    $maxSalesQty = floor($maxSalesQty / $step) * $step;
    $qty = ceil($qty / $step) * $step;
}

$maxSalesQtyLength = ($maxSalesQty ? strlen((string) $maxSalesQty) : 4)
    + (/* add one if decimal for separator */ (int) $stockItemViewModel->isQtyDecimal($product));

?>
<style>
    /* Custom styles for cart item prices to enforce Net/Gross styling */
    .cart.item .price-box .price-including-tax {
        font-weight: 700 !important;
        display: block;
    }
    .cart.item .price-box .price-excluding-tax {
        font-weight: 400 !important;
        font-size: 0.875rem;
        color: #6b7280;
        display: block;
    }
    .cart.item .price-box .price-excluding-tax .label {
        text-transform: lowercase;
    }
</style>

<article class="cart item p-4 bg-white border border-gray-200 rounded-lg shadow-sm mb-4 flex flex-col md:flex-row gap-4 md:gap-6"
    <?php foreach ($block->getData('cart_item_data_attributes') ?? [] as $attribute => $include): ?>
        <?php if ($include): ?>
            <?php /** Append data-* attributes based on layout XML arguments */ ?>
            <?= $escaper->escapeHtml(sprintf('data-%s', $attribute)); ?>="<?= $escaper->escapeHtmlAttr($item->getData($attribute)); ?>"
        <?php endif; ?>
    <?php endforeach; ?>
    x-data="{
        qty: <?= (float)$qty ?>,
        minQty: <?= (float)($minSalesQty ?: 1) ?>,
        maxQty: <?= (float)($maxSalesQty ?: 10000) ?>,
        step: <?= (float)$step ?>,
        increment() {
            if (this.qty < this.maxQty) this.qty += this.step;
        },
        decrement() {
            if (this.qty > this.minQty) this.qty -= this.step;
        }
    }"
>
    <?php if ($block->hasProductUrl()): ?>
        <a
            href="<?= $escaper->escapeUrl($block->getProductUrl()) ?>"
            tabindex="-1"
            class="product-item-photo shrink-0"
        >
    <?php else: ?>
        <div class="product-item-photo shrink-0">
    <?php endif;?>
        <?= $block->getImage($block->getProductForThumbnail(), 'cart_page_product_thumbnail')
            ->setTemplate('Magento_Catalog::product/image.phtml')
            ->toHtml() ?>
    <?php if ($block->hasProductUrl()): ?>
        </a>
    <?php else: ?>
        </div>
    <?php endif; ?>

    <div class="flex flex-col grow">
        <div class="product-item-details grow">
            <div class="flex flex-col md:flex-row justify-between gap-4">
                <h3 class="product-item-name text-lg font-bold text-gray-900 break-all">
                    <?php if ($block->hasProductUrl()): ?>
                        <a href="<?= $escaper->escapeUrl($block->getProductUrl()) ?>" class="hover:text-primary transition-colors">
                            <?= $escaper->escapeHtml($block->getProductName()) ?>
                        </a>
                    <?php else: ?>
                        <?= $escaper->escapeHtml($block->getProductName()) ?>
                    <?php endif; ?>
                </h3>

                <div class="price-box flex flex-col items-end text-right">
                    <div class="text-sm text-gray-500 mb-1">
                        <?php if ($qty > 1): ?>
                            <span><?= $escaper->escapeHtmlAttr(__('%1 x', $qty)) ?></span>
                        <?php endif; ?>
                        <span class="text-fg-secondary">
                            <?= $block->getUnitPriceHtml($item) ?>
                        </span>
                    </div>
                    <div class="font-bold text-lg text-gray-900">
                        <?= $block->getRowTotalHtml($item) ?>
                    </div>
                </div>
            </div>

            <?php if ($options = $block->getOptionList()): ?>
                <dl class="mt-2 item-options text-sm text-gray-600">
                    <?php foreach ($options as $option): ?>
                        <?php $formatedOptionValue = $block->getFormatedOptionValue($option) ?>
                        <div class="flex gap-2">
                            <dt class="font-medium min-w-16">
                                <?= $escaper->escapeHtml($option['label']) ?>:
                            </dt>
                            <dd class="font-normal">
                                <?php if (isset($formatedOptionValue['full_view'])): ?>
                                    <?= $escaper->escapeHtml($formatedOptionValue['full_view']) ?>
                                <?php else: ?>
                                    <?= $escaper->escapeHtml($formatedOptionValue['value'], ['span', 'a']) ?>
                                <?php endif; ?>
                            </dd>
                        </div>
                    <?php endforeach; ?>
                </dl>
            <?php endif;?>

            <?php if ($messages = $block->getMessages()): ?>
                <?php foreach ($messages as $message): ?>
                    <div class="cart item message mt-2 p-2 rounded bg-red-50 text-red-700 text-sm border border-red-200 <?= $escaper->escapeHtmlAttr($message['type']) ?>">
                        <div><?= $escaper->escapeHtml($message['text']) ?></div>
                    </div>
                <?php endforeach; ?>
            <?php endif; ?>

            <?php $addInfoBlock = $block->getProductAdditionalInformationBlock(); ?>
            <?php if ($addInfoBlock): ?>
                <div class="mt-2">
                    <?= $addInfoBlock->setItem($item)->toHtml() ?>
                </div>
            <?php endif;?>
        </div>

        <div class="mt-4 flex flex-wrap justify-between items-center gap-4 pt-4 border-t border-gray-100">
            <div class="flex items-center border border-gray-300 rounded-md overflow-hidden w-32 h-10">
                <style>
                    /* Hide number input arrows */
                    input[type=number]::-webkit-inner-spin-button,
                    input[type=number]::-webkit-outer-spin-button {
                        -webkit-appearance: none;
                        margin: 0;
                    }
                    input[type=number] {
                        -moz-appearance: textfield;
                    }
                </style>
                <button type="button"
                        @click="decrement"
                        class="px-3 h-full bg-gray-50 text-gray-600 hover:bg-gray-100 border-r border-gray-300 focus:outline-none transition-colors flex items-center justify-center"
                        :class="{'opacity-50 cursor-not-allowed': qty <= minQty}"
                        :disabled="qty <= minQty"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                    </svg>
                </button>

                <label class="sr-only" for="cart-<?= $escaper->escapeHtmlAttr($item->getId()) ?>-qty">
                    <?= $escaper->escapeHtml(__('Qty')) ?>
                </label>
                <input
                    id="cart-<?= $escaper->escapeHtmlAttr($item->getId()) ?>-qty"
                    name="cart[<?= $escaper->escapeHtmlAttr($item->getId()) ?>][qty]"
                    value="<?= $escaper->escapeHtmlAttr($qty) ?>"
                    title="<?= $escaper->escapeHtmlAttr(__('Qty')) ?>"
                    class="form-input px-2 h-full w-full text-center border-none focus:ring-0 text-gray-900 font-medium appearance-none"
                    required
                    <?php if ($stockItemViewModel->isQtyDecimal($product)): ?>
                    type="text"
                    pattern="[0-9]+(\.[0-9]{1,<?= /** @noEscape */ $maxSalesQtyLength ?>})?"
                    inputmode="decimal"
                    <?php else: ?>
                    type="number"
                    pattern="[0-9]{0,<?= /** @noEscape */ $maxSalesQtyLength ?>}"
                    inputmode="numeric"
                    <?php if ($minSalesQty): ?>min="<?= /** @noEscape */ $minSalesQty ?>"<?php endif; ?>
                    <?php if ($maxSalesQty): ?>max="<?= /** @noEscape */ $maxSalesQty ?>"<?php endif; ?>
                    <?php if ($step): ?>step="<?= /** @noEscape */ $step ?>"<?php endif; ?>
                    <?php endif; ?>
                    data-role="cart-item-qty"
                    x-model="qty"
                >

                <button type="button"
                        @click="increment"
                        class="px-3 h-full bg-gray-50 text-gray-600 hover:bg-gray-100 border-l border-gray-300 focus:outline-none transition-colors flex items-center justify-center"
                        :class="{'opacity-50 cursor-not-allowed': qty >= maxQty}"
                        :disabled="qty >= maxQty"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                </button>
            </div>

            <div class="item-actions inline-flex flex-wrap items-center gap-2">
                <a href="<?= $escaper->escapeUrl($block->getConfigureUrl()) ?>"
                   class="shrink-0 btn btn-secondary rounded-md p-2 text-gray-600 hover:text-primary border-gray-300"
                   aria-label="<?= $escaper->escapeHtmlAttr(__('Edit item parameters')) ?>">
                    <?= $lucideIcons->pencilHtml('', 18, 18, ['aria-hidden' => 'true']); ?>
                </a>
                <a href="#"
                   data-post='<?= /* @noEscape */ $block->getDeleteItemParams() ?>'
                   class="shrink-0 btn btn-secondary rounded-md p-2 text-gray-600 hover:text-red-600 border-gray-300 action action-delete"
                   aria-label="<?= $escaper->escapeHtmlAttr(__('Remove item')) ?>"
                >
                    <?= $lucideIcons->trashHtml('', 18, 18, ['aria-hidden' => 'true']); ?>
                </a>
            </div>
        </div>
    </div>
</article>
