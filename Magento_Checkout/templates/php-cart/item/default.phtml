<?php
/**
 * Hyvä Themes - https://hyva.io
 * Copyright © Hyvä Themes. All rights reserved.
 * See COPYING.txt for license details.
 */

declare(strict_types=1);

// phpcs:disable Generic.WhiteSpace.ScopeIndent
// phpcs:disable Magento2.Files.LineLength.MaxExceeded

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\ProductStockItem;
use Hyva\Theme\ViewModel\LucideIcons;
use Magento\Checkout\Block\Cart\Item\Renderer;
use Magento\Framework\Escaper;

/** @var Renderer $block */
/** @var Escaper $escaper */
/** @var ViewModelRegistry $viewModels */

/** @var ProductStockItem $stockItemViewModel */
$stockItemViewModel = $viewModels->require(ProductStockItem::class);

/** @var LucideIcons $lucideIcons */
$lucideIcons = $viewModels->require(LucideIcons::class);

$item = $block->getItem();
$product = $item->getProduct();
$isVisibleProduct = $product->isVisibleInSiteVisibility();

$minSalesQty = $stockItemViewModel->getMinSaleQty($product);
$maxSalesQty = $stockItemViewModel->getMaxSaleQty($product);
$qty = $stockItemViewModel->isQtyDecimal($product)
    ? $block->getQty()
    : (int)$block->getQty();

$step = $stockItemViewModel->getQtyIncrements($product)
    ? $stockItemViewModel->getQtyIncrements($product)
    : 1;

/**
 * sets minimum and maximum values taking into account the values set in the admin,
 * but taking into account the value of Qty Increments
 */
if ($step > 1) {
    $minSalesQty = ceil($minSalesQty / $step) * $step;
    $maxSalesQty = floor($maxSalesQty / $step) * $step;
    $qty = ceil($qty / $step) * $step;
}

$maxSalesQtyLength = ($maxSalesQty ? strlen((string)$maxSalesQty) : 4)
    + (/* add one if decimal for separator */
    (int)$stockItemViewModel->isQtyDecimal($product));

$deleteParams = json_decode($block->getDeleteItemParams() ?: '{}', true);
?>
<style>
    /* Custom styles for cart item prices to enforce Net/Gross styling */
    .cart.item .price-box .price-including-tax,
    .cart.item .price-box .price-excluding-tax {
        display: block;
        line-height: 1.2;
    }

    .cart.item .price-box .price-including-tax .price,
    .cart.item .price-box .cart-price .price {
        font-weight: 700;
        font-size: 1.25rem; /* text-xl */
        color: #111827; /* text-gray-900 */
    }

    .cart.item .price-box .price-excluding-tax .price {
        font-weight: 400;
        font-size: 0.875rem; /* text-sm */
        color: #6b7280; /* text-gray-500 */
    }

    .cart.item .price-box .price-excluding-tax .label {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: #9ca3af;
        margin-right: 4px;
    }

    /* Hide number input arrows */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    input[type=number] {
        -moz-appearance: textfield;
    }
</style>

<article
    class="cart item p-6 bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-md transition-shadow duration-300 mb-6 flex flex-col sm:flex-row gap-6"
<?php foreach ($block->getData('cart_item_data_attributes') ?? [] as $attribute => $include): ?>
<?php if ($include): ?>
<?php /** Append data-* attributes based on layout XML arguments */ ?>
<?= $escaper->escapeHtml(sprintf('data-%s', $attribute)); ?>="<?= $escaper->escapeHtmlAttr($item->getData($attribute)); ?>"
<?php endif; ?>
<?php endforeach; ?>
x-data="{
        qty: <?= (float)$qty ?>,
        minQty: <?= (float)($minSalesQty ?: 1) ?>,
        maxQty: <?= (float)($maxSalesQty ?: 10000) ?>,
        step: <?= (float)$step ?>,
        timeout: null,
        isLoading: false,
        init() {
            this.$watch('qty', () => this.debouncedUpdate());
        },
        debouncedUpdate() {
            clearTimeout(this.timeout);
            this.timeout = setTimeout(() => {
                this.updateCart();
            }, 800);
        },
        updateCart() {
            this.isLoading = true;
            const form = this.$el.closest('form');
            const formData = new FormData(form);

            // Add form key if missing
            if (!formData.has('form_key')) {
                const formKey = hyva.getCookie('form_key');
                if (formKey) formData.append('form_key', formKey);
            }

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.ok) {
                    // Reload sections using Hyva event
                    window.dispatchEvent(new CustomEvent('reload-customer-section-data', {
                        detail: {
                            sections: ['cart', 'messages']
                        }
                    }));

                    this.fetchAndReplaceCart();
                } else {
                    console.error('Cart update failed');
                    this.isLoading = false;
                }
            })
            .catch(error => {
                console.error('Error updating cart:', error);
                this.isLoading = false;
            });
        },
        fetchAndReplaceCart() {
             fetch(window.location.href)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');

                    // Replace Cart Items
                    const newItems = doc.querySelector('#form-validate');
                    const currentItems = document.querySelector('#form-validate');
                    if (newItems && currentItems) {
                        // Remove scripts to avoid redeclaration errors
                        const scripts = newItems.querySelectorAll('script');
                        scripts.forEach(script => script.remove());

                        currentItems.innerHTML = newItems.innerHTML;
                    }

                    // Replace Totals
                    const newTotals = doc.querySelector('.cart-summary');
                    const currentTotals = document.querySelector('.cart-summary');
                    if (newTotals && currentTotals) {
                         const scripts = newTotals.querySelectorAll('script');
                         scripts.forEach(script => script.remove());
                        currentTotals.replaceWith(newTotals);
                    }

                    // Replace Messages
                    const newMessages = doc.querySelector('.page.messages');
                    const currentMessages = document.querySelector('.page.messages');
                    if (newMessages && currentMessages) {
                        currentMessages.replaceWith(newMessages);
                    } else if (newMessages) {
                         // Insert if missing
                         const main = document.querySelector('#maincontent');
                         if (main) main.prepend(newMessages);
                    }

                    this.isLoading = false;
                });
        },
        increment() {
            if (this.qty < this.maxQty) this.qty += this.step;
        },
        decrement() {
            if (this.qty > this.minQty) this.qty -= this.step;
        }
    }"
>
<!-- Product Image -->
<?php if ($block->hasProductUrl()): ?>
<a
    href="<?= $escaper->escapeUrl($block->getProductUrl()) ?>"
    tabindex="-1"
    class="product-item-photo shrink-0 w-full sm:w-32 md:w-40 aspect-square flex items-center justify-center bg-gray-50 rounded-lg overflow-hidden"
>
    <?php else: ?>
    <div
        class="product-item-photo shrink-0 w-full sm:w-32 md:w-40 aspect-square flex items-center justify-center bg-gray-50 rounded-lg overflow-hidden">
        <?php endif; ?>
        <?= $block->getImage($block->getProductForThumbnail(), 'cart_page_product_thumbnail')
            ->setTemplate('Magento_Catalog::product/image.phtml')
            ->toHtml() ?>
        <?php if ($block->hasProductUrl()): ?>
</a>
<?php else: ?>
    </div>
<?php endif; ?>

<!-- Product Details -->
<div class="flex flex-col grow justify-between">
    <div class="product-item-details">
        <!-- Header: Name -->
        <div class="flex justify-between items-start gap-4 mb-2">
            <h3 class="product-item-name text-lg font-bold text-gray-900 leading-tight">
                <?php if ($block->hasProductUrl()): ?>
                    <a href="<?= $escaper->escapeUrl($block->getProductUrl()) ?>"
                       class="hover:text-primary transition-colors">
                        <?= $escaper->escapeHtml($block->getProductName()) ?>
                    </a>
                <?php else: ?>
                    <?= $escaper->escapeHtml($block->getProductName()) ?>
                <?php endif; ?>
            </h3>
        </div>

        <!-- Options -->
        <?php if ($options = $block->getOptionList()): ?>
            <dl class="mt-2 item-options text-sm text-gray-600 space-y-1">
                <?php foreach ($options as $option): ?>
                    <?php $formatedOptionValue = $block->getFormatedOptionValue($option) ?>
                    <div class="flex gap-2">
                        <dt class="font-medium min-w-[4rem]">
                            <?= $escaper->escapeHtml($option['label']) ?>:
                        </dt>
                        <dd class="font-normal text-gray-800">
                            <?php if (isset($formatedOptionValue['full_view'])): ?>
                                <?= $escaper->escapeHtml($formatedOptionValue['full_view']) ?>
                            <?php else: ?>
                                <?= $escaper->escapeHtml($formatedOptionValue['value'], ['span', 'a']) ?>
                            <?php endif; ?>
                        </dd>
                    </div>
                <?php endforeach; ?>
            </dl>
        <?php endif; ?>

        <!-- Messages -->
        <?php if ($messages = $block->getMessages()): ?>
            <?php foreach ($messages as $message): ?>
                <div
                    class="cart item message mt-3 p-3 rounded-md bg-red-50 text-red-700 text-sm border border-red-200 flex items-start gap-2 <?= $escaper->escapeHtmlAttr($message['type']) ?>">
                    <svg xmlns="http://www.w3.org/2000/svg" class="shrink-0 w-5 h-5" width="20" height="20"
                         viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                    <div><?= $escaper->escapeHtml($message['text']) ?></div>
                </div>
            <?php endforeach; ?>
        <?php endif; ?>

        <?php $addInfoBlock = $block->getProductAdditionalInformationBlock(); ?>
        <?php if ($addInfoBlock): ?>
            <div class="mt-2">
                <?= $addInfoBlock->setItem($item)->toHtml() ?>
            </div>
        <?php endif; ?>
    </div>

    <!-- Footer: Controls & Price -->
    <div class="mt-6 flex flex-wrap items-end justify-between gap-4 pt-4 border-t border-gray-100">

        <!-- Qty & Actions -->
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex items-center border border-gray-300 rounded-lg overflow-hidden h-10 shadow-sm relative">
                <!-- Loading Overlay -->
                <div x-show="isLoading" class="absolute inset-0 bg-white/80 z-10 flex items-center justify-center">
                    <svg class="animate-spin h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>

                <button type="button"
                        @click="decrement"
                        class="px-3 h-full bg-gray-50 text-gray-600 hover:bg-gray-100 hover:text-gray-900 border-r border-gray-300 focus:outline-none transition-colors flex items-center justify-center"
                        :class="{'opacity-50 cursor-not-allowed': qty <= minQty}"
                        :disabled="qty <= minQty || isLoading"
                        aria-label="<?= $escaper->escapeHtmlAttr(__('Decrease quantity')) ?>"
                >
                    <?= $lucideIcons->minusHtml('', 16, 16) ?>
                </button>

                <label class="sr-only" for="cart-<?= $escaper->escapeHtmlAttr($item->getId()) ?>-qty">
                    <?= $escaper->escapeHtml(__('Qty')) ?>
                </label>
                <input
                    id="cart-<?= $escaper->escapeHtmlAttr($item->getId()) ?>-qty"
                    name="cart[<?= $escaper->escapeHtmlAttr($item->getId()) ?>][qty]"
                    value="<?= $escaper->escapeHtmlAttr($qty) ?>"
                    title="<?= $escaper->escapeHtmlAttr(__('Qty')) ?>"
                    class="form-input px-2 h-full w-14 text-center border-none focus:ring-0 text-gray-900 font-semibold appearance-none bg-white"
                    required
                    <?php if ($stockItemViewModel->isQtyDecimal($product)): ?>
                        type="text"
                        pattern="[0-9]+(\.[0-9]{1,<?= /** @noEscape */
                        $maxSalesQtyLength ?>})?"
                        inputmode="decimal"
                    <?php else: ?>
                        type="number"
                        pattern="[0-9]{0,<?= /** @noEscape */
                        $maxSalesQtyLength ?>}"
                        inputmode="numeric"
                        <?php if ($minSalesQty): ?>min="<?= /** @noEscape */
                        $minSalesQty ?>"<?php endif; ?>
                        <?php if ($maxSalesQty): ?>max="<?= /** @noEscape */
                        $maxSalesQty ?>"<?php endif; ?>
                        <?php if ($step): ?>step="<?= /** @noEscape */
                        $step ?>"<?php endif; ?>
                    <?php endif; ?>
                    data-role="cart-item-qty"
                    x-model="qty"
                    :disabled="isLoading"
                >

                <button type="button"
                        @click="increment"
                        class="px-3 h-full bg-gray-50 text-gray-600 hover:bg-gray-100 hover:text-gray-900 border-l border-gray-300 focus:outline-none transition-colors flex items-center justify-center"
                        :class="{'opacity-50 cursor-not-allowed': qty >= maxQty}"
                        :disabled="qty >= maxQty || isLoading"
                        aria-label="<?= $escaper->escapeHtmlAttr(__('Increase quantity')) ?>"
                >
                    <?= $lucideIcons->plusHtml('', 16, 16) ?>
                </button>
            </div>

            <div class="shrink-0 flex flex-wrap gap-2">
                <a href="<?= $escaper->escapeUrl($block->getConfigureUrl()) ?>"
                   class="shrink-0 btn rounded-full p-3 border-transparent bg-gray-200 text-gray-500 hover:border-transparent hover:bg-blue-500 hover:text-white transition-colors"
                   aria-label="<?= $escaper->escapeHtmlAttr(__('Edit item parameters')) ?>">
                    <?= $lucideIcons->pencilHtml('', 20, 20, ['aria-hidden' => 'true']); ?>
                </a>
                <button type="button"
                   @click="hyva.postForm('<?= $escaper->escapeJs($deleteParams['action'] ?? '') ?>', <?= json_encode($deleteParams['data'] ?? []) ?>)"
                   class="shrink-0 btn rounded-full p-3 border-transparent bg-gray-200 text-gray-500 hover:border-transparent hover:bg-gray-700 hover:text-white transition-colors action action-delete"
                   aria-label="<?= $escaper->escapeHtmlAttr(__('Remove item')) ?>"
                >
                    <?= $lucideIcons->trashHtml('', 20, 20, ['aria-hidden' => 'true']); ?>
                </button>
            </div>
        </div>

        <!-- Price Box -->
        <div class="price-box flex flex-col items-end text-right">
            <div class="text-xs text-gray-500 mb-1 flex items-center gap-1">
                <span class="bg-gray-100 px-1.5 py-0.5 rounded text-gray-600 font-bold" x-show="qty > 0"
                      x-text="qty + ' x'"></span>
                <span class="text-gray-500">
                        <?= $block->getUnitPriceHtml($item) ?>
                    </span>
            </div>
            <div class="price-total mb-1 flex items-center gap-1">
                <span class="bg-gray-100 px-1.5 py-0.5 rounded text-gray-600 font-bold"><?= __("Total") ?></span>
                <span>
                    <?= $block->getRowTotalHtml($item) ?>
                </span>
            </div>
        </div>

    </div>
</div>
</article>
