<?php
/**
 * Hyvä Themes - https://hyva.io
 * Copyright © Hyvä Themes. All rights reserved.
 * See COPYING.txt for license details.
 */

declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\LucideIcons;
use Hyva\Theme\ViewModel\HyvaCsp;
use Hyva\Theme\ViewModel\Cart\TotalsOutput;
use Magento\Checkout\Block\Cart\Shipping;
use Magento\Framework\Escaper;

/** @var Escaper $escaper */
/** @var Shipping $block */
/** @var HyvaCsp $hyvaCsp */
/** @var ViewModelRegistry $viewModels */
/** @var HyvaCsp $hyvaCsp */

/** @var LucideIcons $lucideIcons */
$lucideIcons = $viewModels->require(LucideIcons::class);

$showIcon = $block->getShowIcon() ?? true;

/** @var TotalsOutput $totalsOutput */
$totalsOutput = $viewModels->require(TotalsOutput::class);

// Get address from quote
$quote = $block->getQuote();
$shippingAddress = $quote->getShippingAddress();

$initialCountryId = $shippingAddress->getCountryId();
$initialRegionId = $shippingAddress->getRegionId();
$initialRegion = $shippingAddress->getRegion();
$initialPostcode = $shippingAddress->getPostcode();

// If quote address is missing or invalid (like '*'), try to load default shipping address from customer
if ((empty($initialPostcode) || $initialPostcode === '*') && $quote->getCustomerId()) {
    try {
        $objectManager = \Magento\Framework\App\ObjectManager::getInstance();
        $customerRepository = $objectManager->get(\Magento\Customer\Api\CustomerRepositoryInterface::class);
        $customer = $customerRepository->getById($quote->getCustomerId());

        $defaultShippingId = $customer->getDefaultShipping();
        if ($defaultShippingId) {
            $addressRepository = $objectManager->get(\Magento\Customer\Api\AddressRepositoryInterface::class);
            $address = $addressRepository->getById($defaultShippingId);

            $initialCountryId = $address->getCountryId();
            $initialRegionId = $address->getRegionId();
            // Region name might need separate lookup if only ID is available, but often ID is enough for select
            $initialPostcode = $address->getPostcode();
        }
    } catch (\Exception $e) {
        // Ignore errors if customer or address not found
    }
}
?>

<script>
    function initShippingEstimation() {
        return {
            showEstimateShipping: true, // Default to true
            cart: false,
            cartIsVirtual: false,
            customer: false,
            availableShippingMethods: [],
            isLoading: false,
            cartData: {
                address: {
                    countryId: '<?= $escaper->escapeJs($initialCountryId) ?>' || window.checkoutConfig.defaultCountryId,
                    regionId: '<?= $escaper->escapeJs($initialRegionId) ?>' || window.checkoutConfig.defaultRegionId,
                    region: '<?= $escaper->escapeJs($initialRegion) ?>' || '',
                    postcode: '<?= $escaper->escapeJs($initialPostcode) ?>' || window.checkoutConfig.defaultPostcode
                },
                cartVersion: Math.floor(Date.now() / 1000),
                rates: [],
                shippingCarrierCode: null,
                shippingMethodCode: null,
            },
            checkoutData: {
                shippingAddressFromData: {
                    country_id: window.checkoutConfig.defaultCountryId,
                    region: window.checkoutConfig.defaultRegionId,
                    postcode: window.checkoutConfig.defaultPostcode
                }
            },
            directoryData: false,
            shippingMethod: false,
            phpInitialData: {
                countryId: '<?= $escaper->escapeJs($initialCountryId) ?>',
                postcode: '<?= $escaper->escapeJs($initialPostcode) ?>'
            },
            init() {
                this.cartIsVirtual = parseInt(this.$root.dataset.isCartVirtual);
                const selectedShippingMethod = window.checkoutConfig.selectedShippingMethod;
                if (selectedShippingMethod) {
                    this.shippingMethod = `${selectedShippingMethod.carrier_code}_${selectedShippingMethod.method_code}`
                }

                const browserStorageShowEstimateShipping = hyva.getBrowserStorage().getItem('hyva.showEstimateShipping');
                // Default to true if not set in storage
                this.showEstimateShipping = browserStorageShowEstimateShipping === null ? true : (browserStorageShowEstimateShipping === 'true');

                // If open, fetch methods immediately
                if (this.showEstimateShipping) {
                    // We need to wait for data, but receiveCustomerData handles it.
                }
            },
            toggleEstimateShipping() {
                this.showEstimateShipping = !this.showEstimateShipping;

                hyva.getBrowserStorage().setItem('hyva.showEstimateShipping', this.showEstimateShipping);

                if (this.showEstimateShipping) {
                    this.fetchShippingMethods();
                }
            },
            estimateShippingIconClasses() {
                return {
                    'rotate-180': this.showEstimateShipping
                }
            },
            abortShippingController: null,
            fetchShippingMethods() {

                if (this.abortShippingController) {
                    this.abortShippingController.abort();
                }
                this.isLoading = true;
                this.$dispatch('update-shipping-method-start', {});

                const path = this.customer && this.customer.fullname
                    ? '/V1/carts/mine/estimate-shipping-methods'
                    : '/V1/guest-carts/' + this.cart.cartId + '/estimate-shipping-methods';

                // ensure a new controller is used for the new request
                this.abortShippingController = new AbortController();

                fetch(BASE_URL + 'rest/' + CURRENT_STORE_CODE + path + '?form_key=' + hyva.getFormKey(), {
                    signal: this.abortShippingController.signal,
                    method: 'post',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        address: this.cartData.address
                    })
                })
                    .then(response => response.json())
                    .then(result => {
                        this.availableShippingMethods = result.filter(method => method.method_code);

                        if (!this.availableShippingMethods.find(method => {
                            return method.carrier_code + '_' + method.method_code === this.shippingMethod
                        })) {
                            this.$dispatch('update-shipping-method', {method: false});
                            this.shippingMethod = false;
                        }
                    })
                    .catch(this.displayError)
                    .finally(() => {
                            this.$dispatch('update-shipping-method-end', {});
                            this.fetchTotals();
                            this.isLoading = false;
                        }
                    );
            },
            getEstimatedShippingRateCarriers() {
                return Array.from(new Set(this.availableShippingMethods.map(rate => rate.carrier_title)));
            },
            getRatesForCarrier(carrierTitle) {
                return this.availableShippingMethods.filter(rate => rate.carrier_title === carrierTitle);
            },
            updateShippingMethod() {
                const method = this.$event.target.value;
                if (method) {
                    this.$dispatch('update-shipping-method', {method: method});
                    this.shippingMethod = method;
                    this.fetchTotals();
                }
            },
            shippingCarrierRadioId(rate) {
                return 'shipping_method_' + rate.method_code;
            },
            shippingCarrierRadioValue(rate) {
                if (!rate) return null;
                return rate.carrier_code + '_' + rate.method_code;
            },
            isShippingMethodSelected(rate) {
                return this.shippingMethod === this.shippingCarrierRadioValue(rate);
            },
            shippingCarrierRateIncl(rate) {
                return hyva.formatPrice(rate.price_incl_tax);
            },
            shippingCarrierRateExcl(rate) {
                return hyva.formatPrice(rate.price_excl_tax);
            },
            shippingRateHasTax(rate) {
                return rate.price_excl_tax !== rate.price_incl_tax
            },
            abortTotalsController: null,
            fetchTotals() {
                if (this.abortTotalsController) {
                    this.abortTotalsController.abort();
                }
                this.$dispatch('update-totals-start', {});

                let carrierCode = null;
                let methodCode = null;

                if (this.shippingMethod) {
                    const splitShippingMethod = this.shippingMethod.split('_');
                    carrierCode = splitShippingMethod[0];
                    // methodCode might contain multiple underscores
                    methodCode = this.shippingMethod.replace(carrierCode + '_', '') || null;
                }
                const path = this.customer && this.customer.fullname
                    ? '/V1/carts/mine/totals-information'
                    : '/V1/guest-carts/' + this.cart.cartId + '/totals-information';

                // ensure a new controller is used for the new request
                this.abortTotalsController = new AbortController();

                fetch(BASE_URL + 'rest/' + CURRENT_STORE_CODE + path + '?form_key=' + hyva.getFormKey(), {
                    signal: this.abortTotalsController.signal,
                    method: 'post',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        addressInformation: {
                            shipping_carrier_code: carrierCode,
                            shipping_method_code: methodCode,
                            address: this.cartData.address
                        }
                    })
                })
                    .then(response => response.json())
                    .then(result => {
                        <?php /* Update total titles to value from window.checkoutConfig so theme translations are applied */ ?>
                        if (window.checkoutConfig && window.checkoutConfig.totalsData) {
                            const checkoutConfigTotals = window.checkoutConfig.totalsData.total_segments || [];
                            result.total_segments.forEach(total => {
                                // Skip shipping segment to preserve dynamic title from API
                                if (total.code === 'shipping') return;

                                const totalFromConfig = checkoutConfigTotals.find(fromConfig => fromConfig.code === total.code)
                                totalFromConfig && (total.title = totalFromConfig.title);
                            })
                        }
                        return result;
                    })
                    .then(result => {
                        this.$dispatch('update-totals', {data: result});
                    })
                    .catch(this.displayError)
                    .finally(() => {
                            this.$dispatch('update-totals-end', {});
                        }
                    );
            },
            receiveCustomerData() {
                const data = this.$event.detail.data;
                let addressChanged = false;

                if (data.cart) {
                    this.cart = data.cart;
                }
                if (data.customer) {
                    this.customer = data.customer;
                }
                if (data['directory-data']) {
                    this.directoryData = data['directory-data'];
                }
                if (data['cart-data']) {
                    // Check if address changed before updating
                    if (JSON.stringify(this.cartData.address) !== JSON.stringify(data['cart-data'].address)) {
                        this.cartData = data['cart-data'];
                        addressChanged = true;
                    } else {
                        this.cartData = data['cart-data'];
                    }
                }
                if (data['checkout-data']) {
                    this.checkoutData = data['checkout-data'];
                    this.populateCartData();
                }

                // If postcode is '*', clear it
                if (this.cartData.address.postcode === '*') {
                    this.cartData.address.postcode = '';
                }

                if (this.phpInitialData.postcode && this.phpInitialData.postcode !== '*' && (!this.cartData.address.postcode || this.cartData.address.postcode === '*')) {
                    this.cartData.address.postcode = this.phpInitialData.postcode;
                    if (this.phpInitialData.countryId) {
                        this.cartData.address.countryId = this.phpInitialData.countryId;
                    }
                    this.saveToCustomerSectionData();
                    addressChanged = true;
                }

                // Only fetch shipping methods if address changed or it's the first load and we have postcode
                if (addressChanged && this.cartData.address.postcode && this.cartData.address.postcode !== '*') {
                     this.fetchShippingMethods();
                } else if (!addressChanged && this.cartData.address.postcode && this.cartData.address.postcode !== '*' && this.availableShippingMethods.length === 0) {
                    // If address didn't change but we have a postcode and no methods loaded yet (e.g. page reload), fetch them
                    this.fetchShippingMethods();
                }
            },
            setCountry() {
                const countryId = this.$event.target.value;
                this.cartData.address.countryId = countryId;
                this.checkoutData.shippingAddressFromData.country_id = countryId;
                this.saveToCustomerSectionData();
                this.fetchShippingMethods();
            },
            setRegionSelect() {
                this.setRegion(this.$event, 'select');
            },
            setRegionText() {
                this.setRegion(this.$event);
            },
            setRegion(event, type) {
                const value = event.target.value;
                if (type === 'select') {
                    const countryId = this.cartData.address.countryId;
                    const regionId = value || 0;
                    const regionData = this.directoryData[countryId].regions[regionId] || {code: '', name: ''};

                    this.cartData.address.regionId = regionId;
                    this.cartData.address.regionCode = regionData.code;
                    this.cartData.address.region = regionData.name;

                    this.checkoutData.shippingAddressFromData.region_id = regionId;
                    this.checkoutData.shippingAddressFromData.region_code = regionData.code;
                    this.checkoutData.shippingAddressFromData.region = regionData.name;

                } else {
                    this.cartData.address.region = value;
                    this.checkoutData.shippingAddressFromData.region = value;
                }

                this.saveToCustomerSectionData();
                this.fetchShippingMethods();
            },
            updatePostcode() {
                let value = this.$event.target.value;

                // Remove non-digits
                const digits = value.replace(/\D/g, '');

                // Format as 00-000
                if (digits.length > 2) {
                    value = digits.substring(0, 2) + '-' + digits.substring(2, 5);
                } else {
                    value = digits;
                }

                // Update input value if changed
                if (this.$event.target.value !== value) {
                    this.$event.target.value = value;
                }

                this.cartData.address.postcode = value;
                this.checkoutData.shippingAddressFromData.postcode = value;
                this.saveToCustomerSectionData();
            },
            setPostcode() {
                this.updatePostcode();
                this.fetchShippingMethods();
            },
            postcodeFieldValue() {
                return this.cartData.address && this.cartData.address.postcode;
            },
            isCountrySelected() {
                return this.cartData.address && this.cartData.address.countryId == this.country.id;
            },
            isRegionSelected() {
                return this.cartData.address && this.cartData.address.regionId == this.region.id;
            },
            hasShippingRateCarriers() {
                return this.getEstimatedShippingRateCarriers().length > 0;
            },
            saveToCustomerSectionData() {
                const browserStorage = hyva.getBrowserStorage();

                const sectionData = JSON.parse(browserStorage.getItem('mage-cache-storage')) || {};

                if (!sectionData['checkout-data']) {
                    sectionData['checkout-data'] = {};
                }
                if (!sectionData['cart-data']) {
                    sectionData['cart-data'] = {};
                }

                sectionData['checkout-data'].shippingAddressFromData = this.checkoutData.shippingAddressFromData;
                sectionData['cart-data'].address = this.cartData.address;

                browserStorage.setItem('mage-cache-storage', JSON.stringify(sectionData));
            },
            populateCartData() {
                const checkoutAddress = this.checkoutData && this.checkoutData.shippingAddressFromData || {};

                if (Object.keys(checkoutAddress).length) {

                    if (
                        (checkoutAddress['country_id'] !== this.cartData.address.countryId) ||
                        (checkoutAddress['region'] !== "" || checkoutAddress['region_id'] !== "" || checkoutAddress['postcode'] !== null)
                    ) {
                        this.cartData.address.countryId = checkoutAddress['country_id'];
                        this.cartData.address.region = checkoutAddress['region'];
                        this.cartData.address.postcode = checkoutAddress['postcode'];
                    }
                }
            },
            getSortedCountries() {
                return Object.keys(this.directoryData)
                    .filter(countryKey => countryKey !== 'data_id' && this.directoryData[countryKey].name)
                    .sort((a, b) => {
                        if (this.directoryData[a].name < this.directoryData[b].name) {
                            return -1
                        }
                        if (this.directoryData[a].name > this.directoryData[b].name) {
                            return 1
                        }
                        return 0;
                    }).map(countryId => {
                        return {
                            id: countryId,
                            name: this.directoryData[countryId].name || countryId
                        }
                    });
            },
            getAvailableRegions() {
                const countryId = this.cartData.address.countryId;

                if (
                    countryId &&
                    this.directoryData[countryId] &&
                    this.directoryData[countryId].regions
                ) {
                    return Object.keys(this.directoryData[countryId].regions).map(regionId => {
                        return {
                            id: regionId,
                            code: this.directoryData[countryId].regions[regionId].code,
                            name: this.directoryData[countryId].regions[regionId].name
                        }
                    });
                }
                return [];
            },
            hasAvailableRegions() {
                return this.cartData.address && this.cartData.address.countryId && this.getAvailableRegions().length
            },
            isShowRegionTextField() {
                return this.directoryData && !this.hasAvailableRegions()
            },
            regionTextFieldValue() {
                return this.cartData.address && this.cartData.address.region;
            },
            displayError(error) {
                if (error.name !== 'AbortError') {
                    console.error(error);
                    typeof window.dispatchMessages !== "undefined" && window.dispatchMessages(
                        [{
                            type: "error",
                            text: "<?= $escaper->escapeJs(__("Something went wrong. Please try again.")) ?>"
                        }], 10000
                    );
                }
            }
        }
    }

    window.addEventListener('alpine:init', () => {
        Alpine.data('initShippingEstimation', initShippingEstimation)
    }, {once: true});
</script>
<?php $hyvaCsp->registerInlineScript() ?>

<details
    id="block-shipping"
    class="estimate-shipping-form group"
    x-data="initShippingEstimation"
    data-is-cart-virtual="<?= (int)$block->getQuote()->isVirtual() ?>"
    @private-content-loaded.window="receiveCustomerData"
    :open="showEstimateShipping"
>
    <summary
        @click.prevent="toggleEstimateShipping"
        class="list-none flex justify-between items-center gap-2 py-2 font-semibold"
    >
        <span class="inline-flex items-center gap-2">
            <?= $showIcon ? $lucideIcons->giftHtml('text-primary', 20, 20, ['aria-hidden' => 'true']) : ''; ?>
            <?= $block->getQuote()->isVirtual()
                ? $escaper->escapeHtml(__('Estimate Tax'))
                : $escaper->escapeHtml(__('Estimate Shipping and Tax'))
            ?>
        </span>
        <?= $lucideIcons->chevronDownHtml('transform group-open:rotate-180', 20, 20, ['aria-hidden' => 'true']); ?>
    </summary>
    <div class="mb-4">
        <form method="post" id="shipping-zip-form" @submit.prevent="fetchTotals()">
            <fieldset class="fieldset estimate" aria-labelledby="block-shipping-title">
                <p class="field note">
                    <?= $block->getQuote()->isVirtual() ?
                        $escaper->escapeHtml(__('Enter your billing address to get a tax estimate.')) :
                        $escaper->escapeHtml(__('Enter your destination to get a shipping estimate.'))
                    ?>
                </p>

                <div class="hidden field mt-2" name="shippingAddress.country_id">

                    <label class="label">
                        <?= $escaper->escapeHtml(__('Country')) ?>

                        <select class="form-select w-full"
                                name="country_id"
                                aria-invalid="false"
                                @change.debounce="setCountry"
                        >
                            <option value=""></option>
                            <template x-for="country in getSortedCountries" :key="country.id">
                                <option :value="country.id" x-text="country.name"
                                        :selected="isCountrySelected"></option>
                            </template>
                        </select>

                    </label>
                </div>

                <div class="hidden field mt-2" name="shippingAddress.region_id">

                    <template x-if="hasAvailableRegions">

                        <label class="label">
                            <?= $escaper->escapeHtml(__('State/Province')) ?>

                            <select class="form-select w-full"
                                    id="region_id"
                                    name="region_id"
                                    @change.debounce="setRegionSelect"
                            >
                                <option value="">
                                    <?= $escaper->escapeHtml(__('Please select a region, state or province.')) ?>
                                </option>
                                <template x-for="region in getAvailableRegions" :key="region.id">
                                    <option :data-code="region.code" :value="region.id" x-text="region.name"
                                            :selected="isRegionSelected"></option>
                                </template>
                            </select>
                        </label>
                    </template>

                    <template x-if="isShowRegionTextField">

                        <label class="label">
                            <?= $escaper->escapeHtml(__('State/Province')) ?>

                            <input class="form-input w-full"
                                   id="region"
                                   type="text"
                                   name="region"
                                   @change.debounce="setRegionText"
                                   :value="regionTextFieldValue"
                            >
                        </label>
                    </template>
                </div>

                <div class="field mt-2" name="shippingAddress.postcode">

                    <label class="label">
                        <?= $escaper->escapeHtml(__('Zip/Postal Code')) ?>
                    </label>
                    <input class="form-input w-full"
                           type="text"
                           name="postcode"
                           placeholder="00-000"
                           @input="updatePostcode"
                           @input.debounce.1000ms="fetchShippingMethods"
                           @keydown.enter.prevent="fetchShippingMethods"
                           :value="postcodeFieldValue"
                    >
                </div>

                <template x-if="hasShippingRateCarriers">
                    <div
                        class="relative mt-4 space-y-4"
                        role="radiogroup"
                        aria-label="<?= $escaper->escapeHtmlAttr(__('Shipping Methods')) ?>"
                    >
                        <?= $block->getBlockHtml('block-loader') ?>
                        <template x-for="carrier in getEstimatedShippingRateCarriers" :key="carrier">
                            <div class="space-y-2">
                                <h5 class="text-sm font-bold text-gray-800 border-b pb-1 mb-2" x-text="carrier"></h5>
                                <template x-for="(rate, index) in getRatesForCarrier(carrier)" :key="index">
                                    <label class="flex items-start justify-between p-3 border rounded-md cursor-pointer hover:bg-gray-50 transition-colors"
                                           :class="isShippingMethodSelected(rate) ? 'border-primary bg-blue-50 ring-1 ring-primary' : 'border-gray-200 bg-white'">
                                        <div class="flex items-start gap-3">
                                            <input
                                                type="radio"
                                                name="shippingEstimationSelection"
                                                class="text-primary focus:ring-primary mt-1"
                                                :id="shippingCarrierRadioId(rate)"
                                                :value="shippingCarrierRadioValue(rate)"
                                                :checked="isShippingMethodSelected(rate)"
                                                @change="updateShippingMethod"
                                            >
                                            <div class="w-full">
                                                <span class="text-sm font-medium text-gray-900 block" x-text="rate.method_title"></span>
                                                <div x-show="rate.extension_attributes && rate.extension_attributes.description"
                                                     class="text-xs text-gray-500 mt-1 w-full"
                                                     x-text="rate.extension_attributes && rate.extension_attributes.description"></div>

                                                <!-- Promotion Message -->
                                                <div x-show="rate.extension_attributes && rate.extension_attributes.promotion_message && rate.extension_attributes.promotion_message !== 'undefined'"
                                                     class="mt-2 p-2 text-xs rounded"
                                                     style="border: 1px solid #fcd34d; background-color: #fffbeb; color: #92400e;">
                                                    <strong class="block mb-1"><?= $block->escapeHtml(__('Special offer (included in cart):')) ?></strong>
                                                    <span x-html="rate.extension_attributes ? rate.extension_attributes.promotion_message : ''"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <?php if ($totalsOutput->displayCartShippingInclTax() || $totalsOutput->displayCartShippingBoth()): ?>
                                                <div class="text-sm font-bold text-gray-900 whitespace-nowrap block">
                                                    <span
                                                        x-text="shippingCarrierRateIncl(rate)"
                                                        class="price-including-tax"
                                                    ></span>
                                                </div>
                                            <?php endif; ?>
                                            <?php if ($totalsOutput->displayCartShippingExclTax() || $totalsOutput->displayCartShippingBoth()): ?>
                                                <div class="text-xs text-gray-500 whitespace-nowrap block" :class="{'mt-1': shippingRateHasTax(rate)}">
                                                    <span
                                                        x-text="shippingCarrierRateExcl(rate)"
                                                        x-show="shippingRateHasTax(rate)"
                                                        class="price-excluding-tax"
                                                    ></span>
                                                    <span x-show="shippingRateHasTax(rate)" class="text-xs text-gray-500"><?= $escaper->escapeHtml(__('net')) ?></span>
                                                </div>
                                            <?php endif; ?>
                                        </div>
                                    </label>
                                </template>
                            </div>
                        </template>
                    </div>
                </template>
            </fieldset>
        </form>
    </div>
</details>

<?= $block->getChildHtml() ?>
