<?php
/**
 * Hyvä Themes - https://hyva.io
 * Copyright © Hyvä Themes 2020-present. All rights reserved.
 * This product is licensed per Magento install
 * See https://hyva.io/license
 */

declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\HyvaCsp;
use Hyva\Theme\ViewModel\StoreConfig;
use Hyva\Theme\ViewModel\HeroiconsSolid;
use Hyva\Theme\ViewModel\LucideIcons;
use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;

/** @var Escaper $escaper */
/** @var Template $block */
/** @var HyvaCsp $hyvaCsp */
/** @var ViewModelRegistry $viewModels */

$storeConfig = $viewModels->require(StoreConfig::class);
$maxItemsToDisplay = $storeConfig->getStoreConfig('checkout/sidebar/max_items_display_count');

/** @var HeroiconsSolid $heroiconsSolid */
$heroiconsSolid = $viewModels->require(HeroiconsSolid::class);

/** @var LucideIcons $lucideIcons */
$lucideIcons = $viewModels->require(LucideIcons::class);

$miniCartOptionQtyStyle = (string) $block->getQtyStyle() ?: 'default';
$miniCartOptionShowSku = $block->getShowSku() !== null ? (bool) $block->getShowSku() : false;
$miniCartOptionQtySaveAuto = $miniCartOptionQtyStyle === "incrementor" || $miniCartOptionQtyStyle === "select";
?>

<style>
    /* Custom styles for cart drawer prices */
    .cart-drawer-price {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }

    .cart-drawer-price .price-including-tax,
    .cart-drawer-price .price-excluding-tax {
        display: block;
        line-height: 1.2;
    }

    /* Brutto (Including Tax) */
    .cart-drawer-price .price-including-tax .price {
        font-weight: 700;
        font-size: 1rem; /* 16px */
        color: #111827; /* gray-900 */
    }

    /* Netto (Excluding Tax) */
    .cart-drawer-price .price-excluding-tax .price {
        font-weight: 400;
        font-size: 0.875rem; /* 14px */
        color: #6b7280; /* gray-500 */
    }

    /* Netto Label */
    .cart-drawer-price .price-excluding-tax::after {
        content: attr(data-label);
        font-size: 0.75rem; /* 12px */
        text-transform: lowercase;
        color: #9ca3af; /* gray-400 */
        margin-left: 4px;
    }
</style>

<script>
    function initCartDrawer() {
        return {
            open: false,
            // --- NOWE: Inicjalizacja obserwatora blokady scrolla ---
            init() {
                this.$watch('open', value => {
                    document.body.classList.toggle('overflow-hidden', value);
                });
            },
            // -------------------------------------------------------
            closed() {
                return !this.open
            },
            isLoading: false,
            cart: {},
            maxItemsToDisplay: <?= (int) $maxItemsToDisplay ?>,
            itemsCount: 0,
            showSku: <?= $miniCartOptionShowSku ? 'true' : 'false' ?>,
            autocompleteNumber: 100,
            showDetails() {
                return this.item.options && this.item.options.length || this.showSku;
            },
            cartIsEmpty() {
                return this.itemsCount === 0
            },
            getData() {
                const data = this.$event.detail.data;

                if (data.cart) {
                    this.cart = data.cart;
                    this.itemsCount = data.cart.items && data.cart.items.length || 0;
                    this.setCartItems();
                }
                this.isLoading = false;
            },
            cartItems: [],
            getItemCountTitle() {
                return hyva.strf('<?= $escaper->escapeJs(__('%0 of %1 products in cart displayed')) ?>', this.maxItemsToDisplay, this.itemsCount)
            },
            shouldShowItemCount() {
                return this.maxItemsToDisplay && this.maxItemsToDisplay < this.itemsCount;
            },
            setCartItems() {
                this.cartItems = this.cart.items && this.cart.items.sort((a, b) => b.item_id - a.item_id) || [];

                if (this.maxItemsToDisplay > 0) {
                    this.cartItems = this.cartItems.slice(0, parseInt(this.maxItemsToDisplay, 10));
                }
            },
            updateItemQty(event) {
                const form = event.target;
                this.isLoading = true;
                hyvaAjaxFormMinicart({ form, redirect: false }, () => {
                    this.isLoading = false;
                });
            },
            deleteItemFromCart() {
                const itemId = this.item.item_id;
                const formKey = hyva.getFormKey();
                this.isLoading = true;

                hyvaAjaxFormMinicart({
                    url: BASE_URL + 'checkout/sidebar/removeItem/',
                    body: 'form_key=' + formKey + '&item_id=' + itemId,
                    message: '<?= $escaper->escapeJs(__('You removed the item.')) ?>'
                }, () => {
                    this.isLoading = false
                });
            },
            toggleCartDrawer(event) {
                if (event.detail && event.detail.isOpen) {
                    this.open = event.detail.isOpen;
                } else {
                    this.open = !this.open;
                }
                this.calcCartDrawerAnchor();
            },
            openCartDrawer() {
                this.open = true;
                this.calcCartDrawerAnchor();
            },
            closeCartDrawer() {
                this.open = false;
            },
            getSectionDataExtraActions() {
                if (!this.cart.extra_actions) {
                    return '';
                }

                const contentNode = document.createElement('div');
                contentNode.innerHTML = this.cart.extra_actions;

                hyva.activateScripts(contentNode);

                return contentNode.innerHTML;
            },
            calcCartDrawerAnchor() {
                const btn = this.$refs.cartButton ? this.$refs.cartButton.getBoundingClientRect() : {};
                const scrollOffset = window.pageYOffset || document.documentElement.scrollTop;
                const btnOffset = btn.top && (btn.top + btn.height);
                const offsetTop = btnOffset
                    ? `${btnOffset < 0 ? btnOffset + scrollOffset : btnOffset}px`
                    : "1rem";
                const offsetRight = btn.right ? `${Math.floor((window.innerWidth - btn.right) + (btn.width / 4))}px` : "1rem";

                const drawer = this.$refs.cartDialogContent;
                if(drawer) {
                    drawer.style.setProperty('--cart-drawer-offset-right', offsetRight);
                    drawer.style.setProperty('--cart-drawer-offset-top', offsetTop);
                }
            },
            productIsVisibleInSite() {
                return this.item.product_has_url && this.item.is_visible_in_site_visibility
            },
            productIsNotVisibleInSite() {
                return !this.productIsVisibleInSite()
            },
            productIsNotGroupedAndVisibleInSite() {
                return this.item.product_type !== 'grouped' && this.item.is_visible_in_site_visibility
            },
            productAriaLabel() {
                return hyva.strf(this.$el.dataset.ariaLabel, this.item.product_name)
            },
            proceedToCheckout() {
                this.closeCartDrawer()

                this.$dispatch(
                    'toggle-authentication',
                    {
                        url: '<?= $escaper->escapeUrl($block->getUrl('checkout')) ?>'
                    }
                )
            },
            setItemMessage(itemId, message) {
                const items = this.cartItems;
                items.forEach((item) => {
                    if (item.item_id === itemId) {
                        item.message = message;
                    }
                });
            },
            cartListeners: {
                ['@private-content-loaded.window'](event) {
                    this.getData(event.detail.data);
                },
                ['@toggle-cart.window'](event) {
                    this.toggleCartDrawer(event);
                },
                ['@keydown.window.escape']() {
                    this.$dispatch('toggle-cart', { isOpen: false })
                },
                ['@resize.window.debounce']() {
                    if (!this.open) return;
                    this.calcCartDrawerAnchor();
                },
                ['@minicart-error-message.window'](event) {
                    if (!event.detail) return;
                    const { itemId, message } = event.detail;
                    this.setItemMessage(itemId, message);
                }
            }
        }
    }

    function initCartDrawerQtyBox() {
        return {
            initQty: 0,
            itemQty: 0,
            prevQty: 0,
            minValue: 0,
            init() {
                this.setQtyDefaults();
                this.$watch('item.qty', () => this.setQtyDefaults());
                const inputField = this.$root.querySelector('[name="item_qty"]');
                this.minValue = inputField ? inputField.min : 0;
            },
            updateQty() {
                const submitEvent = new Event('submit', { cancelable: true });
                this.$root.dispatchEvent(submitEvent);
            },
            updateQtyValue(event) {
                this.itemQty = event.target.value;
            },
            updateQtyOnFocus() {
                this.prevQty = this.itemQty;
                this.itemQty = null;
            },
            updateQtyOnBlur() {
                if (this.itemQty === null) {
                    this.itemQty = this.prevQty
                }
            },
            setQtyDefaults() {
                this.initQty = this.item.qty;
                this.itemQty = this.item.qty;
                this.prevQty = this.item.qty;
            },
            decrement() {
                this.itemQty <= this.minValue ? this.itemQty = this.minValue : this.itemQty--;
            },
            increment() {
                this.itemQty++
            },
            qtyHasNewValue() {
                return this.itemQty === this.initQty || this.itemQty === null;
            }
        }
    }

    window.addEventListener('alpine:init', () => {
        Alpine.data('initCartDrawer', initCartDrawer);
        Alpine.data('initCartDrawerQtyBox', initCartDrawerQtyBox);
    }, { once: true })

    async function hyvaAjaxFormMinicart(
        {
            form = null,
            url = '',
            body = '',
            redirect = 'default',
            message = '',
        } = {},
        callback = () => {}
    ) {
        const formData = body ? body : (form ? new FormData(form) : '');
        const postUrl = url ? url : (form ? form.action : '');
        if (!formData || !postUrl) {
            console.warn('You must provide the form or formData and postUrl!');
            return;
        }

        const formUenc = hyva.getUenc();
        const itemId = body ? new URLSearchParams(body).get('item_id') : formData.get('item_id');
        let bodyUrl = new URLSearchParams(formData);
        bodyUrl.append('uenc', formUenc);

        try {
            const response = await fetch(postUrl, {
                method: 'POST',
                body: bodyUrl.toString(),
                mode: 'cors',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (!response.ok) {
                return form.submit();
            }

            if (redirect === 'default' && response.redirected) {
                return window.location.href = response.url;
            } else if (redirect !== 'default' && redirect !== false) {
                return window.location.href = redirect;
            }

            const responseBody = await response.json();

            if (!responseBody.success) {
                throw responseBody.error_message;
            }

            window.dispatchEvent(new CustomEvent('reload-customer-section-data'));
        } catch (error) {
            window.dispatchEvent(new CustomEvent('minicart-error-message', { detail: { itemId, message: error } }));
        } finally {
            callback();
        }
    }
</script>
<?php $hyvaCsp->registerInlineScript() ?>

<div x-data="initCartDrawer" x-bind="cartListeners" @keydown.window.escape="closeCartDrawer">

    <div x-show="open"
         x-transition:enter="transition-opacity ease-linear duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition-opacity ease-linear duration-300"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @click="closeCartDrawer"
         class="fixed inset-0 z-20 black-opacity w-full h-full backdrop-blur-sm"
         aria-hidden="true"
         x-cloak
    ></div>

    <section
        id="cart-drawer"
        aria-labelledby="cart-drawer-title"
        class="flex flex-col gap-y-6 py-6 px-4 [&_>*]:px-2 max-w-full z-30 fixed top-0 right-0 h-full
            md:w-[450px] w-full bg-white text-slate-800 shadow-2xl transform transition-transform duration-300 ease-in-out"
        :class="open ? 'translate-x-0' : 'translate-x-full'"
        x-ref="cartDialogContent"
        x-cloak
    >
        <?= $block->getChildHtml('cart-drawer.top'); ?>

        <div class="flex gap-4 justify-between items-center border-b border-gray-100 pb-4">
            <div class="flex items-center gap-2">
                <h2 id="cart-drawer-title" class="text-2xl font-bold text-gray-900">
                    <?= $escaper->escapeHtml(__('My Cart')) ?>
                </h2>
                <span
                    class="bg-gray-100 text-gray-600 text-xs font-bold px-2 py-1 rounded-full"
                    x-show="shouldShowItemCount"
                    x-text="itemsCount"
                ></span>
            </div>
            <button
                type="button"
                class="btn btn-secondary btn-square rounded-full p-2 text-gray-500 hover:bg-gray-100 hover:text-gray-900 transition-colors"
                @click="closeCartDrawer"
                aria-label="<?= $escaper->escapeHtmlAttr(__('Close minicart')) ?>"
            >
                <?= $heroiconsSolid->xHtml('', 24, 24, ['aria-hidden' => 'true']); ?>
            </button>
        </div>

        <?= $block->getChildHtml('cart-drawer.items.before'); ?>

        <template x-if="cartIsEmpty">
            <div class="grow grid place-items-center">
                <div class="text-center p-8">
                    <div class="w-32 h-32 mx-auto mb-6 bg-gray-50 rounded-full flex items-center justify-center text-gray-300">
                        <?= $heroiconsSolid->shoppingCartHtml('', 64, 64, ['aria-hidden' => 'true']); ?>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">
                        <?= $escaper->escapeHtml(__('Your cart is empty')) ?>
                    </h3>
                    <p class="text-gray-500 mb-8">
                        <?= $escaper->escapeHtml(__("Looks like you haven't made your choice yet.")) ?>
                    </p>
                    <button
                        type="button"
                        @click="closeCartDrawer"
                        class="btn btn-primary"
                    ><?= $escaper->escapeHtml(__('Start Shopping')) ?></button>
                </div>
            </div>
        </template>

        <template x-if="itemsCount">
            <ul class="grow flex flex-col overflow-y-auto overscroll-y-contain pr-2 -mr-2 space-y-6">
                <template x-for="item in cartItems">
                    <li class="flex gap-4 items-start pb-6 border-b border-gray-100 last:border-0 last:pb-0">
                        <template x-if="productIsVisibleInSite">
                            <a
                                class="block shrink-0 w-24 aspect-square bg-gray-50 rounded-lg overflow-hidden border border-gray-100 flex items-center justify-center"
                                :href="item.product_url"
                                data-aria-label="<?= $escaper->escapeHtmlAttr(__('Product "%0"')) ?>"
                                :title="item.product_name"
                            >
                                <img
                                    :src="item.product_image.src"
                                    :width="item.product_image.width"
                                    :height="item.product_image.height"
                                    loading="lazy"
                                    :alt="item.product_name"
                                    class="object-contain w-full h-full"
                                >
                            </a>
                        </template>
                        <template x-if="productIsNotVisibleInSite">
                            <div class="block shrink-0 w-24 aspect-square bg-gray-50 rounded-lg overflow-hidden border border-gray-100 flex items-center justify-center">
                                <img
                                    :src="item.product_image.src"
                                    :width="item.product_image.width"
                                    :height="item.product_image.height"
                                    loading="lazy"
                                    :alt="item.product_name"
                                    class="object-contain w-full h-full"
                                />
                            </div>
                        </template>
                        <div class="grow flex flex-col gap-2">
                            <div class="flex justify-between items-start gap-2">
                                <h3 class="text-base font-bold text-gray-900 leading-tight">
                                    <template x-if="productIsVisibleInSite">
                                        <a :href="item.product_url" class="hover:text-primary transition-colors" x-html="item.product_name"></a>
                                    </template>
                                    <template x-if="productIsNotVisibleInSite">
                                        <span x-html="item.product_name"></span>
                                    </template>
                                </h3>
                            </div>

                            <div class="cart-drawer-price" x-html="item.product_price"></div>

                            <template x-if="showDetails">
                                <dl class="text-xs text-gray-500 space-y-1">
                                    <template x-if="showSku">
                                        <div class="flex gap-1">
                                            <dt class="font-medium uppercase"><?= $escaper->escapeHtml(__('Sku')) ?>:</dt>
                                            <dd x-html="item.product_sku"></dd>
                                        </div>
                                    </template>
                                    <template x-for="option in item.options">
                                        <div class="flex gap-1">
                                            <dt class="font-medium" x-text="option.label + ':'"></dt>
                                            <dd x-html="option.value"></dd>
                                        </div>
                                    </template>
                                </dl>
                            </template>

                            <div class="flex items-center justify-between mt-auto pt-2">
                                <?= $block->getLayout()->getBlock('cart-drawer.qtybox')
                                    ->setMiniCartOptionQtyStyle($miniCartOptionQtyStyle)
                                    ->toHtml() ?>

                                <div class="shrink-0 flex flex-wrap gap-2">
                                    <a
                                        :href="item.configure_url"
                                        x-show="productIsNotGroupedAndVisibleInSite"
                                        class="shrink-0 btn rounded-full p-3 border-transparent bg-gray-200 text-gray-500 hover:border-transparent hover:bg-blue-500 hover:text-white transition-colors"
                                        data-aria-label="<?= $escaper->escapeHtmlAttr(__('Edit product "%0"')) ?>"
                                        :aria-label="productAriaLabel"
                                    >
                                        <?= $lucideIcons->pencilHtml('', 20, 20, ['aria-hidden' => 'true']); ?>
                                    </a>
                                    <button
                                        type="button"
                                        class="shrink-0 btn rounded-full p-3 border-transparent bg-gray-200 text-gray-500 hover:border-transparent hover:bg-gray-700 hover:text-white transition-colors action action-delete"
                                        @click="deleteItemFromCart"
                                        data-aria-label="<?= $escaper->escapeHtmlAttr(__('Remove product "%0" from cart')) ?>"
                                        :aria-label="productAriaLabel"
                                    >
                                        <?= $lucideIcons->trashHtml('', 20, 20, ['aria-hidden' => 'true']); ?>
                                    </button>
                                </div>
                            </div>
                            <template x-if="item.message">
                                <div class="text-xs text-red-600 mt-1" x-text="item.message"></div>
                            </template>
                        </div>
                    </li>
                </template>
            </ul>
        </template>

        <?= $block->getChildHtml('cart-drawer.bottom'); ?>

        <template x-if="itemsCount">
            <div class="border-t border-gray-100 pt-6 mt-auto bg-white">
                <?= $block->getChildHtml('cart-drawer.totals.before'); ?>

                <div class="flex justify-between items-center mb-6">
                    <span class="text-lg font-medium text-gray-600"><?= $escaper->escapeHtml(__('Subtotal')) ?></span>
                    <span class="text-2xl font-bold text-gray-900" x-html="cart.subtotal"></span>
                </div>

                <div class="flex flex-col gap-3">
                    <a
                        @click.prevent.stop="proceedToCheckout"
                        href="<?= $escaper->escapeUrl($block->getUrl('checkout')) ?>"
                        class="btn btn-primary w-full justify-center py-3 text-base"
                    >
                        <?= $escaper->escapeHtml(__('Checkout')) ?>
                    </a>
                    <a
                        href="<?= $escaper->escapeUrl($block->getUrl('checkout/cart')) ?>"
                        class="btn btn-secondary w-full justify-center py-3 text-base"
                    >
                        <?= $escaper->escapeHtml(__('View Cart')) ?>
                    </a>
                    <div x-html="getSectionDataExtraActions"></div>
                    <?= $block->getChildHtml('extra_actions'); ?>
                </div>
            </div>
        </template>

        <?php if ($miniCartOptionQtyStyle === "select"): ?>
            <datalist id="minicart-autocomplete">
                <template x-for="i in autocompleteNumber">
                    <option :value="i"></option>
                </template>
            </datalist>
        <?php endif; ?>

        <?= $block->getChildHtml('loading') ?>
    </section>
</div>
