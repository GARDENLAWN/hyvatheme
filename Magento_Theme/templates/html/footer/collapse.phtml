<?php
/**
 * Hyvä Themes - https://hyva.io
 * Copyright © Hyvä Themes 2020-present. All rights reserved.
 * This product is licensed per Magento install
 * See https://hyva.io/license
 */

declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\HeroiconsSolid;
use Hyva\Theme\ViewModel\HeroiconsOutline;
use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;

/** @var Escaper $escaper */
/** @var Template $block */
/** @var ViewModelRegistry $viewModels */

/** @var HeroiconsSolid $heroiconsSolid */
$heroiconsSolid = $viewModels->require(HeroiconsSolid::class);

/** @var HeroiconsOutline $heroicons */
$heroicons = $viewModels->require(HeroiconsOutline::class);

$blockId = (string) $block->getBlockId() ?: $block->getNameInLayout() ?: uniqid();
$title = (string) $block->getTitle() ?: __("Details");
$open = (bool) $block->getOpen() ? 'true' : 'false';
$iconName = (string) $block->getIcon();

$iconHtml = null;
$debugInfo = ''; // Variable to store debug info

if ($iconName) {
    // Convert kebab-case to camelCase + Html suffix (e.g. shopping-bag -> shoppingBagHtml)
    $camelCaseName = str_replace('-', '', ucwords($iconName, '-'));
    $method = lcfirst($camelCaseName) . 'Html';

    try {
        // Try to load the icon using magic method
        $iconHtml = $heroicons->$method('text-primary', 24, 24);
    } catch (\Exception $e) {
        $debugInfo = '<!-- Icon Error: ' . $e->getMessage() . ' -->';
        // If icon not found, try fallbacks for common issues
        try {
            if ($iconName === 'user') {
                $iconHtml = $heroicons->usersHtml('text-primary', 24, 24);
            }
        } catch (\Exception $e2) {
            // Icon definitely not found
        }
    }
}
?>

<?php if ($childrenHtml = $block->getChildHtml()): ?>
    <div
        x-data="mobileFooterCollpase"
        x-bind="eventListeners"
        class="border-b border-gray-100 lg:border-b-0 last:border-b-0"
        data-open="<?= /** @noEscape */ $open ?>"
        data-debug-icon="<?= $escaper->escapeHtmlAttr($iconName) ?>"
    >
        <?= $debugInfo ?>
        <div
            class="group flex w-full items-center justify-between py-4 lg:py-0 gap-3 cursor-pointer lg:cursor-default select-none lg:select-auto transition-colors hover:bg-gray-50 lg:hover:bg-transparent px-2 lg:px-0 -mx-2 lg:mx-0 rounded-lg lg:rounded-none"
            data-id="<?= $blockId ?>"
            x-bind="setToggleRoles"
            @click="toggle"
            @keyup.enter="toggle"
            @keyup.space="toggle"
        >
            <div class="flex items-center gap-3">
                <?php if ($iconHtml): ?>
                    <div class="p-2 bg-primary-50 rounded-lg shrink-0 flex items-center justify-center">
                        <?= $iconHtml ?>
                    </div>
                <?php else: ?>
                    <!-- DEBUG: Icon not found for '<?= $escaper->escapeHtml($iconName) ?>' -->
                    <div class="p-2 bg-red-50 rounded-lg shrink-0 flex items-center justify-center text-red-500 text-xs font-mono border border-red-200">
                        ?
                    </div>
                <?php endif; ?>
                <h3 class="font-bold text-gray-900 text-lg lg:text-xl"><?= $escaper->escapeHtml($title); ?></h3>
            </div>
            <span
                class="transition-transform duration-300 group-aria-expanded:rotate-180 lg:hidden text-gray-400 bg-gray-100 rounded-full p-1.5"
                x-ref="toggleIcon"
            >
                <?= $heroiconsSolid->chevronDownHtml('', 20, 20, ["aria-hidden" => 'true']); ?>
            </span>
        </div>
        <div
            id="<?= $blockId ?>"
            class="aria-[hidden=true]:hidden lg:block overflow-hidden transition-all duration-300 ease-in-out"
            x-bind="setCollapseRoles"
            x-show="isOpen"
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 -translate-y-2"
            x-transition:enter-end="opacity-100 translate-y-0"
        >
            <div class="pt-2 pb-6 lg:pt-6 lg:pb-0 px-2 lg:px-0">
                <?= /** @noEscape */ $childrenHtml ?>
            </div>
        </div>
    </div>
<?php endif; ?>
