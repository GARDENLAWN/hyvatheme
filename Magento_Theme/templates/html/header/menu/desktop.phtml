<?php
/**
 * Hyvä Themes - https://hyva.io
 * Copyright © Hyvä Themes 2020-present. All rights reserved.
 * This product is licensed per Magento install
 * See https://hyva.io/license
 */

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\HyvaCsp;
use Hyva\Theme\ViewModel\HeroiconsSolid;
use Hyva\Theme\ViewModel\Navigation;
use Magento\Framework\View\Element\Template;
use Magento\Framework\Escaper;
use Magento\Cms\Block\BlockByIdentifier as CmsBlock;

/** @var Template $block */
/** @var Escaper $escaper */
/** @var ViewModelRegistry $viewModels */
/** @var HyvaCsp $hyvaCsp */

/** @var Navigation $viewModelNavigation */
$viewModelNavigation = $viewModels->require(Navigation::class, $block);

/** @var HeroiconsSolid $heroiconsSolid */
$heroiconsSolid = $viewModels->require(HeroiconsSolid::class);

$maxLevel = $block->getmaxLevel() ?: 3;
$canOpenOnHover = true; // Force open on hover as requested
$topMenuCtaItem = $block->getTopMenuCtaItem();

// Order is important here: 1. build the menu data, 2. then set the cache tags from the view model identities
$menu = $viewModelNavigation->getNavigation(2 + $maxLevel);
$block->setData('cache_tags', $viewModelNavigation->getIdentities());

function hasSubcategories($item): bool
{
    if (empty($item['childData'])) {
        return false;
    }
    foreach ($item['childData'] as $child) {
        if (!empty($child['childData'])) {
            return true;
        }
    }
    return false;
}
?>

<nav
    class="navigation relative hidden lg:block grow"
    aria-label="<?= $escaper->escapeHtmlAttr(__('Main menu')) ?>"
    data-max-level="<?= $maxLevel ?>"
    x-data="initMenuDesktop"
    x-ref="nav-desktop"
    @load.window="setActiveMenu"
>
    <ul class="flex flex-wrap gap-x-1">
        <?php foreach ($menu as $item): ?>
            <?php if (!empty($item['childData'])): ?>
                <li
                    class="level-0 relative group/item"
                    x-data="initMenuDesktopItem"
                    @click.outside="close"
                    @keydown.escape="close"
                    @mouseenter="canHoverOpen"
                    @mouseleave="canHoverClose"
                >
                    <?php
                        $menuId = 'desktop-menu-' . str_replace('-node', '', $item['id']);
                        $cmsBlockHtml = $this->getLayout()
                            ->createBlock(CmsBlock::class)
                            ->setIdentifier($menuId)
                            ->toHtml();
                        $hasSubcategories = hasSubcategories($item);
                    ?>
                    <button
                        type="button"
                        class="level-0 group w-full flex justify-between items-center gap-1.5 py-2.5 px-4 rounded-full
                            text-gray-700 font-bold text-sm transition-all duration-300 border border-transparent
                            hover:bg-gray-100 hover:text-primary hover:border-gray-200
                            aria-expanded:bg-primary aria-expanded:text-white aria-expanded:shadow-md aria-expanded:border-primary
                            data-[has-current]:text-primary data-[has-current]:bg-primary/5"
                        @click="toggle"
                        aria-expanded="false"
                        :aria-expanded="open"
                        aria-controls="<?= $escaper->escapeHtml($menuId) ?>"
                    >
                        <?= $escaper->escapeHtml($item['name']) ?>
                        <?= $heroiconsSolid->chevronDownHtml(
                            'w-4 h-4 transition-transform duration-300 group-aria-expanded:rotate-180 text-gray-400 group-hover:text-primary group-aria-expanded:text-white/90',
                            16,
                            16,
                            ['aria-hidden' => 'true']
                        ) ?>
                    </button>
                    <div
                        id="<?= $escaper->escapeHtml($menuId) ?>"
                        class="z-30 absolute top-full left-0 mt-3 min-w-[260px] rounded-2xl bg-white shadow-[0_10px_40px_-10px_rgba(0,0,0,0.15)] ring-1 ring-black/5
                            <?= !empty($cmsBlockHtml) ? "grid grid-cols-[minmax(0px,1fr)_theme('spacing.72')]" : '' ?>"
                        x-show="open"
                        x-transition:enter="transition ease-out duration-200"
                        x-transition:enter-start="opacity-0 translate-y-2 scale-95"
                        x-transition:enter-end="opacity-100 translate-y-0 scale-100"
                        x-transition:leave="transition ease-in duration-150"
                        x-transition:leave-start="opacity-100 translate-y-0 scale-100"
                        x-transition:leave-end="opacity-0 translate-y-2 scale-95"
                        x-cloak
                    >
                        <?php
                            $childCount = count($item['childData']);
                            $ulClass = 'gap-1';

                            if ($hasSubcategories) {
                                $ulClass .= ' flex flex-col w-80';
                            } else {
                                if ($childCount > 8) {
                                    $ulClass .= ' grid grid-cols-2 w-[40rem] gap-x-4';
                                } else {
                                    $ulClass .= ' flex flex-col w-72';
                                }
                            }
                        ?>
                        <div class="relative bg-white rounded-l-2xl p-3">
                            <div class="mb-2 pb-2 border-b border-gray-100">
                                <a
                                    href="<?= $escaper->escapeUrl($item['url']) ?>"
                                    class="group/link flex items-center justify-between p-3 rounded-xl text-sm font-bold text-gray-900 hover:bg-primary/5 hover:text-primary transition-all duration-200"
                                >
                                    <?= $escaper->escapeHtml(__('See all %1', $item['name'])) ?>
                                    <span class="bg-gray-100 text-gray-400 rounded-full p-1 group-hover/link:bg-primary group-hover/link:text-white transition-all duration-200">
                                        <?= $heroiconsSolid->arrowRightHtml('w-3 h-3', 12, 12, ['aria-hidden' => 'true']) ?>
                                    </span>
                                </a>
                            </div>
                            <ul class="<?= $ulClass ?>">
                                <?php foreach ($item['childData'] as $subMenu): ?>
                                    <?= $block->getLayout()->getBlock('topmenu_desktop_item')
                                        ->setItem($subMenu)
                                        ->setLevel(1)
                                        ->toHtml() ?>
                                <?php endforeach; ?>
                            </ul>
                        </div>
                        <?php if (!empty($cmsBlockHtml)): ?>
                            <div class="bg-gray-50 p-6 border-l border-gray-100 rounded-r-2xl">
                                <?= /** @noEscape */ $cmsBlockHtml ?>
                            </div>
                        <?php endif; ?>
                    </div>
                </li>
            <?php else: ?>
                <li>
                    <a
                        href="<?= $escaper->escapeUrl($item['url']) ?>"
                        title="<?= $escaper->escapeHtmlAttr($item['name']) ?>"
                        class="level-0 flex items-center py-2.5 px-4 rounded-full text-gray-700 font-bold text-sm transition-all duration-300 border border-transparent
                            hover:bg-gray-100 hover:text-primary hover:border-gray-200
                            aria-[current=page]:text-primary aria-[current=page]:bg-primary/5 aria-[current=page]:border-primary/10
                            <?= $item['name'] === $topMenuCtaItem ? 'text-red-600 hover:text-red-700 hover:bg-red-50' : '' ?>"
                    >
                        <?= $escaper->escapeHtml($item['name']) ?>
                    </a>
                </li>
            <?php endif; ?>
        <?php endforeach; ?>
    </ul>
</nav>
<script>
    function initMenuDesktop() {
        return {
            maxLevel: parseInt(this.$root.dataset.maxLevel),
            setActiveMenu() {
                Array.from(this.$root.querySelectorAll('a'))
                    .filter(link => link.href === window.location.href.split('?')[0])
                    .forEach(item => {
                        item.setAttribute('aria-current', 'page');

                        for (let level = 0; level < this.maxLevel; level++) {
                            const closestMenu = item.closest(`.level-${level}`);

                            if (closestMenu) {
                                const button = closestMenu.querySelector('button');
                                if (button) {
                                    button.setAttribute('data-has-current', '');
                                }
                            }
                        }
                    }
                );
            }
        }
    }

    function initMenuDesktopItem() {
        return {
            open: false,
            closeTimer: null,
            canHover(func) {
                return window.matchMedia('(hover: hover) and (pointer: fine)').matches;
            },
            canHoverOpen() {
                if (!this.canHover()) return;
                clearTimeout(this.closeTimer);
                this.open = true;
            },
            canHoverClose() {
                if (!this.canHover()) return;
                this.closeTimer = setTimeout(() => {
                    this.open = false;
                }, 150); // Small delay to prevent accidental closing
            },
            toggle() {
                this.open = !this.open;
            },
            close() {
                this.open = false;
            }
        }
    }

    function initSubMenuDesktopItem() {
        return {
            open: false,
            closeTimer: null,
            canHover(func) {
                return window.matchMedia('(hover: hover) and (pointer: fine)').matches;
            },
            canHoverOpen() {
                if (!this.canHover()) return;
                clearTimeout(this.closeTimer);
                this.open = true;
                this.calculatePosition();
            },
            canHoverClose() {
                if (!this.canHover()) return;
                this.closeTimer = setTimeout(() => {
                    this.open = false;
                }, 150);
            },
            toggle() {
                this.open = !this.open;
                if (this.open) {
                    this.calculatePosition();
                }
            },
            calculatePosition() {
                this.$nextTick(() => {
                    const wrapper = this.$refs.childmenuWrapper;
                    if (!wrapper) return;

                    // Reset to default
                    wrapper.classList.remove('left-full', 'right-full', 'mr-2', 'ml-2');
                    wrapper.classList.add('left-full', 'ml-2');

                    // Ensure visibility
                    wrapper.style.display = 'flex'; // Force display to calculate dimensions

                    const rect = wrapper.getBoundingClientRect();
                    if (rect.right > window.innerWidth) {
                        wrapper.classList.remove('left-full', 'ml-2');
                        wrapper.classList.add('right-full', 'mr-2');
                    }
                });
            },
            close() {
                this.open = false;
                if (this.$refs.childmenuToggle) {
                    this.$refs.childmenuToggle.focus();
                }
            },
        }
    }

    window.addEventListener('alpine:init', () => {
        if (typeof initMenuDesktop === 'undefined') {
            Alpine.data('initMenuDesktop', initMenuDesktop);
        }
        if (typeof initMenuDesktopItem === 'undefined') {
            Alpine.data('initMenuDesktopItem', initMenuDesktopItem);
        }
        if (typeof initSubMenuDesktopItem === 'undefined') {
            Alpine.data('initSubMenuDesktopItem', initSubMenuDesktopItem);
        }
    }, { once: true })
</script>
<?php $hyvaCsp->registerInlineScript() ?>
