<?php
/**
 * Hyvä Themes - https://hyva.io
 * Copyright © Hyvä Themes 2020-present. All rights reserved.
 * This product is licensed per Magento install
 * See https://hyva.io/license
 */

declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\HeroiconsSolid;
use Magento\Framework\View\Element\Template;
use Magento\Framework\Escaper;

/** @var Template $block */
/** @var Escaper $escaper */
/** @var ViewModelRegistry $viewModels */

/** @var HeroiconsSolid $heroiconsSolid */
$heroiconsSolid = $viewModels->require(HeroiconsSolid::class);

/** @var string[] $item */
$item = $block->getItem();

/** @var int $level */
$level = $block->getLevel() ?: 0;

if (!$item) {
    return '';
}

$menuId = str_replace('-', '_',$item['id']);
$itemClasses = (string) $block->getItemClasses() ?: "flex items-center gap-2 py-4 px-6 border-b border-gray-100 text-gray-700 font-medium hover:bg-gray-50 hover:text-primary transition-colors -outline-offset-1";
$itemIconSize = (int) $block->getItemIconSize() ?: 20;
$itemIndent = 'ms-4'; // Zmniejszone wcięcie
?>

<?php if (!empty($item['childData'])): ?>
    <li data-level="<?= $level ?>" x-data="initMobileSubMenu">
        <button
            type="button"
            class="w-full justify-between <?= $escaper->escapeHtmlAttr($itemClasses) ?>"
            aria-controls="<?= $escaper->escapeHtml($item['id']) ?>-mobile-menu-panel"
            aria-expanded="false"
            x-ref="openSubMenuBtn"
            :aria-expanded="isOpen"
            :disabled="isOpen"
            @click="open"
        >
            <span class="<?= $level > 0 ? $itemIndent : '' ?> truncate"><?= $escaper->escapeHtml($item['name']) ?></span>
            <span class="btn btn-secondary btn-square rounded-full p-1.5 bg-gray-100 text-gray-500 border-none hover:bg-primary hover:text-white transition-colors shrink-0">
                <?= $heroiconsSolid->chevronRightHtml('', $itemIconSize, $itemIconSize, ['aria-hidden' => 'true']) ?>
            </span>
        </button>
        <ul
            id="<?= $escaper->escapeHtml($item['id']) ?>-mobile-menu-panel"
            class="z-10 absolute inset-0 bg-white overflow-y-auto overscroll-y-contain transition duration-300 flex flex-col"
            x-show="isOpen"
            x-transition:enter-start="opacity-0 translate-x-full"
            x-transition:enter-end="opacity-100 translate-x-0"
            x-transition:leave-start="opacity-100 translate-x-0"
            x-transition:leave-end="opacity-0 translate-x-full"
            @keydown.escape.stop.prevent="close"
        >
            <li data-level="<?= $level + 1 ?>" class="sticky top-0 z-20 bg-white border-b border-gray-100 shadow-sm">
                <button
                    type="button"
                    class="w-full bg-gray-50 font-bold text-gray-900 flex items-center gap-3 py-4 px-6 hover:bg-gray-100 transition-colors"
                    @click="close"
                    x-ref="closeSubMenuBtn"
                >
                    <span class="btn btn-secondary btn-square rounded-full p-1.5 bg-white text-gray-500 border border-gray-200 shrink-0">
                        <?= $heroiconsSolid->chevronLeftHtml('', $itemIconSize, $itemIconSize, ['aria-hidden' => 'true']) ?>
                    </span>
                    <span class="truncate"><?= $escaper->escapeHtml($item['name']) ?></span>
                </button>
            </li>
            <li class="border-b border-gray-100">
                <a
                    href="<?= $escaper->escapeUrl($item['url']) ?>"
                    class="<?= $escaper->escapeHtmlAttr($itemClasses) ?> bg-gray-50/50 font-semibold text-primary"
                >
                    <span class="<?= $escaper->escapeHtmlAttr($itemIndent) ?>">
                        <?= $escaper->escapeHtml(__('See all %1', $item['name'])) ?>
                    </span>
                </a>
            </li>
            <?php foreach ($item['childData'] as $subMenu): ?>
                <?= $block->getLayout()->getBlock('topmenu_mobile_item')
                    ->setItem($subMenu)
                    ->setLevel($level + 1)
                    ->toHtml() ?>
            <?php endforeach; ?>
        </ul>
    </li>
<?php else: ?>
    <li data-level="<?= $level ?>">
        <a
            href="<?= $escaper->escapeUrl($item['url']) ?>"
            class="<?= $escaper->escapeHtmlAttr($itemClasses) ?>"
        >
            <span class="<?= $level > 0 ? $itemIndent : '' ?> truncate"><?= $escaper->escapeHtml($item['name']) ?></span>
        </a>
    </li>
<?php endif; ?>
