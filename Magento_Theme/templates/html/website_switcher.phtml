<?php
/**
 * @var Template $block
 * @var Escaper $escaper
 */

use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;

$websiteSwitcher = $block->getData('view_model');

try {
    $websites = $websiteSwitcher->getAvailableWebsites();
    $currentWebsite = $websiteSwitcher->getCurrentWebsite();

    if (count($websites) <= 1) {
        return;
    }
} catch (Exception $e) {
    return;
}
?>

<div class="website-switcher-container border-b border-gray-200 bg-gray-50 py-2" x-data="gardenLawnHyvathemeHtmlWebsiteSwitcher">
    <div class="container mx-auto px-4">
        <div class="flex w-full">

            <!-- Mobile Dropdown -->
            <div class="relative lg:hidden w-full">
                <button @click="toggle"
                        class="flex w-full items-center justify-between gap-2 rounded-md border border-gray-300 bg-white px-3 py-2 text-sm hover:bg-gray-50"
                        :aria-expanded="open">
                    <div class="flex items-center gap-2">
                        <img src="<?= $escaper->escapeUrl($websiteSwitcher->getWebsiteLogo($currentWebsite)) ?>" alt="<?= $escaper->escapeHtmlAttr($currentWebsite->getName()) ?>" class="h-6 w-auto" />
                        <span><?= $escaper->escapeHtml($currentWebsite->getName()) ?></span>
                    </div>
                    <svg class="h-4 w-4 transition-transform" :class="{ 'rotate-180': open }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>

                <div x-show="open"
                     @click.away="open = false"
                     x-transition
                     class="absolute left-0 right-0 z-50 mt-2 w-full rounded-md border border-gray-200 bg-white shadow-lg">
                    <?php foreach ($websites as $website): ?>
                        <?php if ($website->getId() == $currentWebsite->getId()): ?>
                            <div class="cursor-default bg-primary-50 px-4 py-2 text-sm font-semibold text-primary-700">
                                <img src="<?= $escaper->escapeUrl($websiteSwitcher->getWebsiteLogo($website)) ?>" alt="<?= $escaper->escapeHtmlAttr($website->getName()) ?>" class="h-6 w-auto inline-block mr-2" />
                                <?= $escaper->escapeHtml($website->getName()) ?>
                            </div>
                        <?php else: ?>
                            <a href="<?= $escaper->escapeUrl($websiteSwitcher->getWebsiteUrl($website)) ?>"
                               class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <img src="<?= $escaper->escapeUrl($websiteSwitcher->getWebsiteLogo($website)) ?>" alt="<?= $escaper->escapeHtmlAttr($website->getName()) ?>" class="h-6 w-auto inline-block mr-2" />
                                <?= $escaper->escapeHtml($website->getName()) ?>
                            </a>
                        <?php endif; ?>
                    <?php endforeach; ?>
                </div>
            </div>

            <!-- Desktop Buttons -->
            <div class="hidden lg:flex w-full items-stretch gap-2" id="website-switcher" aria-label="<?= $escaper->escapeHtml(__('Switch website')) ?>">
                <?php foreach ($websites as $website): ?>
                    <?php if ($website->getId() == $currentWebsite->getId()): ?>
                        <span class="flex-1 basis-0 min-w-0 inline-flex justify-center items-center rounded-md border border-primary-600 bg-primary-50 px-3 py-2 text-sm font-semibold text-primary-700 cursor-default truncate" title="<?= $escaper->escapeHtmlAttr($website->getName()) ?>">
                            <img src="<?= $escaper->escapeUrl($websiteSwitcher->getWebsiteLogo($website)) ?>" alt="<?= $escaper->escapeHtmlAttr($website->getName()) ?>" class="h-6 w-auto mr-2" />
                            <?= $escaper->escapeHtml($website->getName()) ?>
                        </span>
                    <?php else: ?>
                        <a href="<?= $escaper->escapeUrl($websiteSwitcher->getWebsiteUrl($website)) ?>"
                           class="flex-1 basis-0 min-w-0 inline-flex justify-center items-center rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 truncate"
                           title="<?= $escaper->escapeHtmlAttr($website->getName()) ?>">
                            <img src="<?= $escaper->escapeUrl($websiteSwitcher->getWebsiteLogo($website)) ?>" alt="<?= $escaper->escapeHtmlAttr($website->getName()) ?>" class="h-6 w-auto mr-2" />
                            <?= $escaper->escapeHtml($website->getName()) ?>
                        </a>
                    <?php endif; ?>
                <?php endforeach; ?>
            </div>
        </div>
    </div>
</div>
<script>
function gardenLawnHyvathemeHtmlWebsiteSwitcher() {
    return {
        open: false,
        toggle() {
            this.open = !this.open;
            window.dispatchEvent(new CustomEvent('toggle-logo', { detail: { open: this.open } }));
        }
    }
}
window.addEventListener('alpine:init', () => Alpine.data('gardenLawnHyvathemeHtmlWebsiteSwitcher', gardenLawnHyvathemeHtmlWebsiteSwitcher), {once: true});
</script>
<?php $hyvaCsp->registerInlineScript() ?>
