<?php
/**
 * @var Template $block
 * @var Escaper $escaper
 */

use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;
use Hyva\Theme\ViewModel\HyvaCsp;

/** @var HyvaCsp $hyvaCsp */

$websiteSwitcher = $block->getData('view_model');

try {
    $websites = $websiteSwitcher->getAvailableWebsites();
    $currentWebsite = $websiteSwitcher->getCurrentWebsite();

    if (count($websites) <= 1) {
        return;
    }
} catch (Exception $e) {
    return;
}

$getLogoPadding = function ($website) {
    return strpos(strtolower($website->getName()), 'finn') !== false ? 'p-2' : 'p-1';
};
?>

<div class="website-switcher-container bg-white border-b border-gray-100 py-2" x-data="gardenLawnHyvathemeHtmlWebsiteSwitcher">
    <div class="container mx-auto px-4">
        <div class="flex w-full justify-center">

            <!-- Mobile Dropdown -->
            <div class="relative lg:hidden w-full max-w-md">
                <button @click="toggle"
                        class="group flex w-full items-center justify-between gap-3 rounded-lg border border-gray-200 bg-white px-3 py-2 transition-all shadow-sm hover:shadow-md"
                        :class="{ 'ring-2 ring-primary ring-offset-2': open }"
                        :aria-expanded="open">
                    <div class="flex items-center gap-3 overflow-hidden w-full">
                        <div class="flex h-12 w-1/2 shrink-0 items-center justify-center rounded transition-all transform group-hover:scale-110 duration-300 <?= $getLogoPadding($currentWebsite) ?>">
                            <img src="<?= $escaper->escapeUrl($websiteSwitcher->getWebsiteLogo($currentWebsite)) ?>"
                                 alt="<?= $escaper->escapeHtmlAttr($currentWebsite->getName()) ?>"
                                 class="max-h-[45px] w-auto h-auto object-contain" />
                        </div>
                        <div class="flex flex-col min-w-0 text-left w-1/2">
                            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider"><?= __('Current Shop') ?></span>
                            <span class="text-base font-bold text-gray-900 whitespace-normal leading-tight"><?= $escaper->escapeHtml($currentWebsite->getName()) ?></span>
                        </div>
                    </div>
                    <svg class="h-5 w-5 text-gray-400 shrink-0 transition-transform duration-200 group-hover:text-gray-600" :class="{ 'rotate-180': open }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>

                <div x-show="open"
                     @click.away="open = false"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0 translate-y-2"
                     x-transition:enter-end="opacity-100 translate-y-0"
                     x-transition:leave="transition ease-in duration-150"
                     x-transition:leave-start="opacity-100 translate-y-0"
                     x-transition:leave-end="opacity-0 translate-y-2"
                     class="absolute left-0 right-0 z-50 mt-2 w-full overflow-hidden rounded-lg border border-gray-100 bg-white shadow-2xl ring-1 ring-black/5">
                    <div class="p-1 space-y-1">
                        <?php foreach ($websites as $website): ?>
                            <?php $isActive = $website->getId() == $currentWebsite->getId(); ?>
                            <?php if ($isActive): ?>
                                <div class="group flex items-center gap-3 rounded bg-gray-50 border border-gray-200 px-3 py-2 shadow-inner">
                                    <div class="flex h-12 w-1/2 shrink-0 items-center justify-center rounded bg-white shadow-inner transition-all transform group-hover:scale-110 duration-300 <?= $getLogoPadding($website) ?>">
                                        <img src="<?= $escaper->escapeUrl($websiteSwitcher->getWebsiteLogo($website)) ?>"
                                             alt="<?= $escaper->escapeHtmlAttr($website->getName()) ?>"
                                             class="max-h-[45px] w-auto h-auto object-contain" />
                                    </div>
                                    <div class="flex flex-col min-w-0 w-1/2">
                                        <span class="text-[10px] font-bold text-primary uppercase tracking-wider flex items-center gap-1">
                                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                                            <?= __('Current Shop') ?>
                                        </span>
                                        <span class="whitespace-normal leading-tight text-sm font-bold text-gray-900"><?= $escaper->escapeHtml($website->getName()) ?></span>
                                    </div>
                                    <div class="ml-auto w-2 h-2 rounded-full bg-green-500 shadow-[0_0_0_4px_rgba(34,197,94,0.2)]"></div>
                                </div>
                            <?php else: ?>
                                <a href="<?= $escaper->escapeUrl($websiteSwitcher->getWebsiteUrl($website)) ?>"
                                   class="group flex items-center gap-3 rounded px-3 py-2 text-gray-700 transition-all hover:bg-gray-50">
                                    <div class="flex h-12 w-1/2 shrink-0 items-center justify-center rounded transition-all transform group-hover:scale-110 duration-300 <?= $getLogoPadding($website) ?>">
                                        <img src="<?= $escaper->escapeUrl($websiteSwitcher->getWebsiteLogo($website)) ?>"
                                             alt="<?= $escaper->escapeHtmlAttr($website->getName()) ?>"
                                             class="max-h-[45px] w-auto h-auto object-contain opacity-70 grayscale group-hover:opacity-100 group-hover:grayscale-0 transition-all" />
                                    </div>
                                    <div class="flex flex-col min-w-0 w-1/2">
                                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider transition-colors group-hover:text-primary"><?= __('Switch to') ?></span>
                                        <span class="whitespace-normal leading-tight text-sm font-bold group-hover:text-gray-900"><?= $escaper->escapeHtml($website->getName()) ?></span>
                                    </div>
                                </a>
                            <?php endif; ?>
                        <?php endforeach; ?>
                    </div>
                </div>
            </div>

            <!-- Desktop Grid -->
            <div class="hidden lg:grid w-full grid-cols-3 gap-6" id="website-switcher" aria-label="<?= $escaper->escapeHtml(__('Switch website')) ?>">
                <?php foreach ($websites as $website): ?>
                    <?php $isActive = $website->getId() == $currentWebsite->getId(); ?>
                    <?php if ($isActive): ?>
                        <div class="group relative flex items-center gap-3 rounded-lg border-2 border-primary bg-white px-5 py-3 shadow-md transition-all duration-300">
                            <div class="flex h-10 w-1/3 shrink-0 items-center justify-center rounded transition-all transform group-hover:scale-110 duration-300 <?= $getLogoPadding($website) ?>">
                                <img src="<?= $escaper->escapeUrl($websiteSwitcher->getWebsiteLogo($website)) ?>"
                                     alt="<?= $escaper->escapeHtmlAttr($website->getName()) ?>"
                                     class="max-h-[45px] w-auto h-auto object-contain" />
                            </div>
                            <div class="flex flex-col min-w-0 w-2/3">
                                <span class="text-[10px] font-bold text-primary uppercase tracking-wider mb-0.5 flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                                    <?= __('Current Shop') ?>
                                </span>
                                <span class="text-base font-extrabold text-gray-900 truncate leading-tight"><?= $escaper->escapeHtml($website->getName()) ?></span>
                            </div>
                            <div class="absolute right-3 top-1/2 -translate-y-1/2">
                                <div class="w-2.5 h-2.5 rounded-full bg-green-500 shadow-[0_0_0_4px_rgba(34,197,94,0.2)] animate-pulse"></div>
                            </div>
                        </div>
                    <?php else: ?>
                        <a href="<?= $escaper->escapeUrl($websiteSwitcher->getWebsiteUrl($website)) ?>"
                           class="group relative flex items-center gap-3 rounded-lg border border-gray-100 bg-white px-4 py-2 shadow-sm transition-all duration-300 hover:shadow-lg hover:-translate-y-1 hover:border-primary">
                            <div class="flex h-10 w-1/3 shrink-0 items-center justify-center rounded transition-all transform group-hover:scale-110 duration-300 <?= $getLogoPadding($website) ?>">
                                <img src="<?= $escaper->escapeUrl($websiteSwitcher->getWebsiteLogo($website)) ?>"
                                     alt="<?= $escaper->escapeHtmlAttr($website->getName()) ?>"
                                     class="max-h-[45px] w-auto h-auto object-contain grayscale opacity-60 transition-all duration-300 group-hover:grayscale-0 group-hover:opacity-100" />
                            </div>
                            <div class="flex flex-col min-w-0 w-2/3">
                                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-0.5 transition-colors group-hover:text-primary"><?= __('Switch to') ?></span>
                                <span class="text-sm font-bold text-gray-600 truncate leading-tight transition-colors group-hover:text-gray-900"><?= $escaper->escapeHtml($website->getName()) ?></span>
                            </div>
                            <div class="absolute right-3 top-1/2 -translate-y-1/2 opacity-0 -translate-x-2 transition-all duration-300 group-hover:opacity-100 group-hover:translate-x-0">
                                <svg class="h-5 w-5 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                                </svg>
                            </div>
                        </a>
                    <?php endif; ?>
                <?php endforeach; ?>
            </div>
        </div>
    </div>
</div>
<script>
function gardenLawnHyvathemeHtmlWebsiteSwitcher() {
    return {
        open: false,
        toggle() {
            this.open = !this.open;
            window.dispatchEvent(new CustomEvent('toggle-logo', { detail: { open: this.open } }));
        }
    }
}
window.addEventListener('alpine:init', () => Alpine.data('gardenLawnHyvathemeHtmlWebsiteSwitcher', gardenLawnHyvathemeHtmlWebsiteSwitcher), {once: true});
</script>
<?php $hyvaCsp->registerInlineScript() ?>
