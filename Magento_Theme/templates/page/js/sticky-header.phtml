<?php
/**
 * Hyvä Themes - https://hyva.io
 * Copyright © Hyvä Themes 2020-present. All rights reserved.
 * This product is licensed per Magento install
 * See https://hyva.io/license
 */

declare(strict_types=1);

use Hyva\Theme\ViewModel\HyvaCsp;
use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;

/** @var Escaper $escaper */
/** @var Template $block */
/** @var HyvaCsp $hyvaCsp */

$hideOnScrollDown = $block->getHideOnScrollDown() !== null
    ? (bool) $block->getHideOnScrollDown()
    : true;
$scrollOffset = (int) $block->getScrollOffset() ?: 100;
$enableCssOnlyStickyStyle = $block->getEnableCssOnlyStickyStyle() !== null
    ? (bool) $block->getEnableCssOnlyStickyStyle()
    : false;
?>

<?php if (!$enableCssOnlyStickyStyle || $hideOnScrollDown): ?>
<script>
    <?php if (!$enableCssOnlyStickyStyle): ?>
        document.addEventListener('DOMContentLoaded', () => {
            const pageHeader = document.querySelector('.page-header');
            if (!pageHeader) return;

            const observer = new IntersectionObserver(([e]) => {
                e.target.dataset.sticky = e.intersectionRatio < 1
            }, { threshold: 1 });
            observer.observe(pageHeader);

            // Dynamiczne obliczanie offsetu dla Website Switchera
            const calculateHeaderOffset = () => {
                const switcher = document.querySelector('.website-switcher-container');
                if (switcher) {
                    const height = switcher.offsetHeight;
                    pageHeader.style.setProperty('--header-top-offset', `-${height}px`);
                    // Ustawienie wysokości animacji scrolla dla CSS-only sticky
                    pageHeader.style.setProperty('--header-scroll-range', `${height}px`);
                } else {
                    pageHeader.style.setProperty('--header-top-offset', '0px');
                    pageHeader.style.setProperty('--header-scroll-range', '0px');
                }
            };

            // Oblicz na starcie i przy zmianie rozmiaru okna
            calculateHeaderOffset();
            window.addEventListener('resize', calculateHeaderOffset);
            // Również po załadowaniu wszystkich zasobów (np. obrazków w switcherze), co może zmienić wysokość
            window.addEventListener('load', calculateHeaderOffset);
        });
    <?php endif; ?>

    <?php if ($hideOnScrollDown): ?>
        window.addEventListener('scrollPosition', () => {
            const scrollOffset = <?= $escaper->escapeJs($scrollOffset) ?>;
            document.documentElement.toggleAttribute('data-header-can-sticky', window.pageYOffset > scrollOffset);
        });
    <?php endif; ?>
</script>
<?php $hyvaCsp->registerInlineScript() ?>
<?php endif; ?>

<style>
    @media (min-width: 1024px) {
        <?php if ($enableCssOnlyStickyStyle): ?>
            @keyframes add-sticky {
                to {
                    box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
                    background-color: #fff;
                }
            }
        <?php endif; ?>

        .page-header {
            position: sticky;
            /* Używamy zmiennej CSS ustawianej przez JS, z fallbackiem na 0 */
            top: var(--header-top-offset, 0px);
            z-index: 30;
            background-color: #fff;
            transition: background-color 150ms, box-shadow 150ms;
        }

        <?php if ($enableCssOnlyStickyStyle): ?>
            @supports (animation-timeline: scroll()) {
                .page-header {
                    background-color: transparent;
                    animation: add-sticky linear both;
                    animation-timeline: scroll();
                    /* Zakres animacji dopasowany do wysokości switchera */
                    animation-range: 0 var(--header-scroll-range, 60px);
                }
            }
        <?php endif; ?>

        <?php if (!$enableCssOnlyStickyStyle): ?>
            .page-header[data-sticky="true"] {
                box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            }
        <?php endif; ?>

        <?php if ($hideOnScrollDown): ?>
            html[data-header-can-sticky][data-scroll-dir-y="down"] .page-header {
                box-shadow: none;
                translate: 0 -100%;
                transition: translate 300ms;
            }
        <?php endif; ?>
    }

    @media (max-width: 1023px) {
        .page-header {
            position: sticky;
            top: 0;
            z-index: 30;
            /* Całkowita przezroczystość na mobile */
            background-color: transparent !important;
            box-shadow: none !important;
            border: none !important;
        }
    }
</style>
