<?php
/**
 * Hyvä Themes - https://hyva.io
 * Copyright © Hyvä Themes. All rights reserved.
 * See COPYING.txt for license details.
 */

use Hyva\Theme\ViewModel\HyvaCsp;
use Hyva\Theme\ViewModel\LucideIcons;
use Hyva\Theme\Model\ViewModelRegistry;
use Magento\Framework\Escaper;
use Magento\Framework\Pricing\Render;
use Magento\Wishlist\Block\Share\Wishlist;

// phpcs:disable Generic.Files.LineLength.TooLong

/** @var Wishlist $block */
/** @var Escaper $escaper */
/** @var HyvaCsp $hyvaCsp */
/** @var ViewModelRegistry $viewModels */

/** @var LucideIcons $lucideIcons */
$lucideIcons = $viewModels->require(LucideIcons::class);

?>
<script>
    function initSharedWishlist() {
        return {
            addItemToCart() {
                hyva.postForm(JSON.parse(this.$el.dataset.itemAddToCartUrl));
            },
            addAllSharedToCart() {
                hyva.postForm(JSON.parse(this.$el.dataset.sharedAddAllToCartUrl));
            }
        }
    }
    window.addEventListener('alpine:init', () => Alpine.data('initSharedWishlist', initSharedWishlist), {once: true})
</script>
<?php $hyvaCsp->registerInlineScript(); ?>
<div class="container">
    <?php if ($block->hasWishlistItems()): ?>
        <form x-data="initSharedWishlist"
              class="form shared wishlist card mb-4"
              action="<?= $escaper->escapeUrl($block->getUrl('wishlist/index/update')) ?>"
              method="post">
            <div class="hidden md:grid grid-cols-3 " id="wishlist-items">
                <div class="text-sm p-2"><?= $escaper->escapeHtml(__('Product')) ?></div>
                <div class="text-sm p-2"><?= $escaper->escapeHtml(__('Comment')) ?></div>
                <div class="text-sm p-2"><?= $escaper->escapeHtml(__('Add to Cart')) ?></div>
            </div>
                <?php foreach ($block->getWishlistItems() as $item): ?>
                    <?php
                    $product = $item->getProduct();
                    $isVisibleProduct = $product->isVisibleInSiteVisibility();
                    ?>
                    <div class="grid grid-cols-1 md:grid-cols-3 even:bg-gray-100" id="wishlist-items">
                        <div class="p-4 flex flex-wrap gap-4 items-center">
                            <div class="md:hidden text-sm w-full ">
                                <?= $escaper->escapeHtml(__('Product')) ?>
                            </div>
                            <a class="product shadow photo mr-4 inline-flex"
                               href="<?= $escaper->escapeUrl($block->getProductUrl($item)) ?>"
                               title="<?= $escaper->escapeHtmlAttr($product->getName()) ?>">
                                <?= $block->getImage(
                                    $product,
                                    'customer_shared_wishlist'
                                )->setTemplate('Magento_Catalog::product/image.phtml')->toHtml() ?>
                            </a>

                            <a class="inline-flex underline w-full"
                               href="<?= $escaper->escapeUrl($block->getProductUrl($item)) ?>"
                            >
                                <?= $escaper->escapeHtml($product->getName()) ?>
                            </a>

                            <div class="w-full">
                                <?=
                                $block->getProductPriceHtml(
                                    $product,
                                    'wishlist_configured_price',
                                    Render::ZONE_ITEM_LIST,
                                    ['item' => $item]
                                );
                                ?>
                                <?= $block->getDetailsHtml($item) ?>
                            </div>
                        </div>

                        <div class="p-4 flex flex-wrap items-center">
                            <?php if ($block->hasDescription($item)): ?>
                                <div class="md:hidden text-sm w-full ">
                                    <?= $escaper->escapeHtml(__('Comment')) ?>
                                </div>
                                <?= /* @noEscape */ $block->getEscapedDescription($item) ?>
                            <?php endif; ?>
                        </div>

                        <div class="p-4 flex flex-wrap gap-2 items-center">

                            <?php if ($product->isSaleable()): ?>
                                <?php if ($isVisibleProduct): ?>
                                    <button type="button"
                                            title="<?= $escaper->escapeHtmlAttr(__('Add to Cart')) ?>"
                                            @click.prevent="addItemToCart"
                                            class="inline-flex btn btn-primary"
                                            data-item-add-to-cart-url="<?= $escaper->escapeHtmlAttr($block->getSharedItemAddToCartUrl($item)) ?>"
                                            data-addto="cart"
                                    >
                                        <?= $lucideIcons->shoppingCartHtml('', 20, 20, ['aria-hidden' => 'true']) ?>
                                        <span class="hidden md:inline ml-2"><?= $escaper->escapeHtml(__('Add to Cart')) ?></span>
                                    </button>
                                <?php endif ?>
                            <?php endif; ?>
                            <?= $block->getChildBlock('customer.wishlist.shared.add.button')->setData('item', $item)->toHtml() ?>
                        </div>
                    </div>
                <?php endforeach ?>

            <div class="actions-toolbar">
                <?php if ($block->isSaleable()): ?>
                    <div class="primary">
                        <button type="button"
                                title="<?= $escaper->escapeHtmlAttr(__('Add All to Cart')) ?>"
                                @click.prevent="addAllSharedToCart"
                                data-shared-add-all-to-cart-url="<?= $escaper->escapeHtmlAttr($block->getSharedAddAllToCartUrl()) ?>"
                                class="shrink-0 btn btn-primary action tocart primary">
                            <span><?= $escaper->escapeHtml(__('Add All to Cart')) ?></span>
                        </button>
                    </div>
                <?php endif; ?>
                <div class="secondary">
                    <a href="<?= $escaper->escapeUrl($block->getBackUrl()) ?>"
                       class="btn btn-secondary shrink-0"
                       x-data="{ clicked: false }"
                       @click="clicked = true">
                        <span x-show="!clicked"><?= $escaper->escapeHtml(__('Back')) ?></span>
                        <span x-show="clicked" class="flex items-center gap-2" style="display: none;">
                            <svg class="animate-spin h-4 w-4 text-current" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <?= $escaper->escapeHtml(__('Back')) ?>
                        </span>
                    </a>
                </div>
            </div>
        </form>
    <?php else: ?>
        <div class="message info empty">
            <div><?= $escaper->escapeHtml(__('Wish List is empty now.')) ?></div>
        </div>
    <?php endif ?>
</div>
