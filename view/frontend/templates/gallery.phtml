<?php

declare(strict_types=1);

use GardenLawn\Core\ViewModel\Gallery;
use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\HyvaCsp;
use Hyva\Theme\ViewModel\HeroiconsOutline;
use Hyva\Theme\ViewModel\HeroiconsSolid;
use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;
use Magento\Framework\Serialize\Serializer\Json;

/** @var Template $block */
/** @var Escaper $escaper */
/** @var ViewModelRegistry $viewModels */
/** @var HyvaCsp $hyvaCsp */

$galleryViewModel = $viewModels->require(Gallery::class);
$worksInfo = $galleryViewModel->getWorksInfo();
$jsonSerializer = new Json();

$heroicons = $viewModels->require(HeroiconsOutline::class);
$heroiconsSolid = $viewModels->require(HeroiconsSolid::class);

// Pagination Logic
$page = (int) ($block->getRequest()->getParam('p') ?? 1);
$pageSize = 5;
$totalItems = count($worksInfo);
$totalPages = (int) ceil($totalItems / $pageSize);

if ($page < 1) {
    $page = 1;
}
if ($page > $totalPages && $totalPages > 0) {
    $page = $totalPages;
}

$offset = ($page - 1) * $pageSize;
$pagedWorksInfo = array_slice($worksInfo, $offset, $pageSize);

// Pass pagination data to the head block
$block->setData('total_pages', $totalPages);
$block->setData('current_page', $page);

?>

<?= $block->getChildHtml('head.additional') ?>

<?php if (!empty($pagedWorksInfo)): ?>
    <div class="container px-4 py-8 mx-auto space-y-16">
        <?php foreach ($pagedWorksInfo as $gallery): ?>
            <?php if (empty($gallery['images'])) continue; ?>
            <?php
                $galleryId = 'gallery-' . ($gallery['id'] ?? uniqid());
                // Use folder name (ID) as title
                $galleryTitle = $gallery['id'] ?? '';

                // Map images to the structure expected by the Hyva Gallery JS
                $mappedImages = array_map(function ($image) {
                    return [
                        'full' => $image['link'],
                        'img' => $image['link'],
                        'thumb' => $image['thumb'],
                        'caption' => '', // Empty caption as requested
                        'type' => 'image',
                        'isMain' => !empty($image['main']),
                        'videoUrl' => null
                    ];
                }, $gallery['images']);
            ?>

            <div class="w-full">
                <h2 class="mb-6 text-3xl font-bold text-center"><?= $escaper->escapeHtml($galleryTitle) ?></h2>

                <script>
                    window['<?= $escaper->escapeJs($galleryId) ?>_data'] = <?= /* @noEscape */ $jsonSerializer->serialize($mappedImages) ?>;
                </script>

                <section
                    id="<?= $escaper->escapeHtmlAttr($galleryId) ?>"
                    class="relative pb-[calc(90px+2rem)]"
                    style="
                        --gallery-ratio: 16/9;
                        --gallery-width: 100%;
                        --thumb-size: 90px;
                    "
                    aria-label="<?= $escaper->escapeHtmlAttr(__('%1 Gallery', $galleryTitle)) ?>"
                    x-data="initGardenGallery('<?= $escaper->escapeJs($galleryId) ?>_data')"
                    x-bind="eventListeners"
                >
                    <!-- Fullscreen Backdrop -->
                    <div
                        class="max-w-full w-[var(--gallery-width)] aspect-[var(--gallery-ratio)]"
                        aria-hidden="true"
                        x-show="fullscreen"
                        x-cloak
                    ></div>
                    <div
                        class="z-50 backdrop"
                        aria-hidden="true"
                        x-show="fullscreen"
                        x-transition.opacity
                        x-cloak
                        @click="closeFullscreen"
                    ></div>

                    <!-- Main Gallery Area -->
                    <div
                        class="relative overflow-hidden bg-white rounded-lg aspect-[var(--gallery-ratio)]"
                        aria-live="polite"
                        aria-atomic="true"
                        x-bind="galleryBody"
                        x-ref="galleryDialog"
                        :class="galleryClasses()"
                        :role="fullscreenRole()"
                        :aria-modal="fullscreen"
                        :aria-label="fullscreenLabel()"
                        @keyup.arrow-right="nextItem"
                        @keyup.arrow-left="prevItem"
                    >
                        <!-- Placeholder / First Image -->
                        <figure class="absolute inset-0 flex flex-col items-center justify-center" :class="firstImageClasses()">
                            <img
                                src="<?= $escaper->escapeUrl($mappedImages[0]['img']) ?>"
                                alt=""
                                class="w-full h-full object-contain"
                                loading="eager"
                            >
                        </figure>

                        <!-- Images Loop -->
                        <template x-for="(image, index) in images" :key="index">
                            <figure
                                class="absolute inset-0 flex flex-col justify-center items-center"
                                :class="imageWrapperFullscreenClasses()"
                                x-show="isActive(index)"
                                x-transition:enter.opacity.duration.500ms
                                x-transition:leave.opacity.duration.0ms
                            >
                                <img
                                    class="w-full h-full object-contain"
                                    :class="imageFullscreenClasses()"
                                    :src="getImage(image)"
                                    alt=""
                                >
                            </figure>
                        </template>

                        <!-- Controls -->
                        <div class="z-0 absolute inset-0 p-2 w-full flex flex-col justify-start items-end gap-2" x-cloak>
                            <button
                                class="p-2 rounded-full transition shadow hover:shadow-primary/30 focus:shadow-primary/30 bg-white text-primary"
                                title="<?= $escaper->escapeHtmlAttr(__('Close fullscreen')) ?>"
                                aria-label="<?= $escaper->escapeHtmlAttr(__('Close fullscreen')) ?>"
                                x-show="fullscreen"
                                @click="closeFullscreen"
                            >
                                <?= $heroicons->xHtml('', 24, 24, ['aria-hidden' => 'true']); ?>
                            </button>
                            <button
                                aria-label="<?= $escaper->escapeHtmlAttr(__('Open fullscreen')) ?>"
                                tabindex="-1"
                                x-show="notFullscreen()"
                                @click="openFullscreen"
                                class="absolute inset-0 w-full -z-10"
                            >
                                <span
                                    title="<?= $escaper->escapeHtmlAttr(__('Open fullscreen')) ?>"
                                    class="block p-2 rounded-full transition shadow hover:shadow-primary/30 focus:shadow-primary/30 bg-white text-primary/50 hover:text-primary focus:text-primary absolute top-2 right-2 z-20"
                                >
                                    <?= $heroicons->arrowsExpandHtml('', 24, 24, ['aria-hidden' => 'true']); ?>
                                </span>
                            </button>
                        </div>

                        <!-- Navigation Arrows -->
                        <nav
                            class="z-10 absolute bottom-2 lg:bottom-4 xl:bottom-8 flex justify-between gap-2 left-2 lg:left-4 xl:left-8 right-2 lg:right-4 xl:right-8"
                            aria-label="<?= $escaper->escapeHtmlAttr(__('%1 Gallery Navigation', $galleryTitle)) ?>"
                            x-show="hasMultipleImages()"
                            x-cloak
                        >
                            <button
                                type="button"
                                tabindex="-1"
                                class="shrink-0 p-1.5 md:p-0 disabled:opacity-30"
                                title="<?= $escaper->escapeHtmlAttr(__('Previous')) ?>"
                                aria-label="<?= $escaper->escapeHtmlAttr(__('Previous')) ?>"
                                :disabled="isAtStart()"
                                @click="prevItem"
                            >
                                <span class="block p-2.5 rounded-full transition shadow hover:shadow-primary/30 focus:shadow-primary/30 bg-white text-primary">
                                    <?= $heroiconsSolid->arrowLeftHtml('', 16, 16, ['aria-hidden' => 'true']) ?>
                                </span>
                            </button>
                            <button
                                type="button"
                                tabindex="-1"
                                class="shrink-0 p-1.5 md:p-0 disabled:opacity-30"
                                title="<?= $escaper->escapeHtmlAttr(__('Next')) ?>"
                                aria-label="<?= $escaper->escapeHtmlAttr(__('Next')) ?>"
                                :disabled="isAtEnd()"
                                @click="nextItem"
                            >
                                <span class="block p-2.5 rounded-full transition shadow hover:shadow-primary/30 focus:shadow-primary/30 bg-white text-primary">
                                    <?= $heroiconsSolid->arrowRightHtml('', 16, 16, ['aria-hidden' => 'true']) ?>
                                </span>
                            </button>
                        </nav>
                    </div>

                    <!-- Thumbnails -->
                    <div
                        class="flex items-center gap-2 outline-0 absolute inset-x-0 bottom-0 h-[var(--thumb-size)]"
                        x-bind="galleryThumbs"
                        x-show="hasMultipleImages()"
                        :class="{ 'z-50 fixed bottom-4 left-1/2 -translate-x-1/2': fullscreen }"
                        x-cloak
                    >
                        <button
                            type="button"
                            class="shrink-0 flex justify-center items-center backdrop-blur bg-white/30 disabled:opacity-30 z-10 absolute left-0 inset-y-0 p-2 h-full"
                            tabindex="-1"
                            :disabled="isAtStart()"
                            @click="prevItem"
                            x-show="thumbsOverflow"
                            x-cloak
                        >
                            <?= $heroicons->chevronLeftHtml() ?>
                        </button>

                        <nav
                            class="group flex snap overflow-auto overscroll-contain gap-2 outline-none mask-overflow h-full items-center"
                            tabindex="0"
                            :class="maskOverflowClasses()"
                            x-ref="jsThumbSlides"
                            @keyup.arrow-right="nextItem"
                            @keyup.arrow-left="prevItem"
                            aria-label="<?= $escaper->escapeHtmlAttr(__('%1 Gallery Thumbnails', $galleryTitle)) ?>"
                        >
                            <template x-for="(image, index) in images" :key="index">
                                <button
                                    type="button"
                                    class="relative shrink-0 border-2 border-transparent w-[90px] h-[90px] flex items-center justify-center overflow-hidden bg-gray-100"
                                    tabindex="-1"
                                    :class="thumbClasses(index)"
                                    :aria-label="'<?= $escaper->escapeJs(__('View image')) ?>' + ' ' + (index + 1)"
                                    :aria-current="thumbIsActive(index)"
                                    x-intersect:enter.full="isThumbInViewEnter(index)"
                                    x-intersect:leave.full="isThumbInViewLeave(index)"
                                    @click="setThumbActive(index)"
                                >
                                    <img
                                        :src="image.thumb"
                                        alt=""
                                        class="w-full h-full object-contain"
                                        loading="lazy"
                                    >
                                </button>
                            </template>
                        </nav>

                        <button
                            type="button"
                            class="shrink-0 flex justify-center items-center backdrop-blur bg-white/30 disabled:opacity-30 z-10 absolute right-0 inset-y-0 p-1 h-full"
                            tabindex="-1"
                            :disabled="isAtEnd()"
                            @click="nextItem"
                            x-show="thumbsOverflow"
                            x-cloak
                        >
                            <?= $heroicons->chevronRightHtml() ?>
                        </button>
                    </div>
                </section>
            </div>
        <?php endforeach; ?>

        <!-- Pagination Controls -->
        <?php if ($totalPages > 1): ?>
            <div class="flex justify-center items-center space-x-2 mt-8">
                <?php if ($page > 1): ?>
                    <a href="?p=<?= $page - 1 ?>" class="px-4 py-2 bg-white border rounded hover:bg-gray-100">
                        <?= $heroicons->chevronLeftHtml('', 20, 20) ?>
                    </a>
                <?php endif; ?>

                <?php for ($i = 1; $i <= $totalPages; $i++): ?>
                    <a href="?p=<?= $i ?>" class="px-4 py-2 border rounded <?= $i === $page ? 'bg-primary text-white border-primary' : 'bg-white hover:bg-gray-100' ?>">
                        <?= $i ?>
                    </a>
                <?php endfor; ?>

                <?php if ($page < $totalPages): ?>
                    <a href="?p=<?= $page + 1 ?>" class="px-4 py-2 bg-white border rounded hover:bg-gray-100">
                        <?= $heroicons->chevronRightHtml('', 20, 20) ?>
                    </a>
                <?php endif; ?>
            </div>
        <?php endif; ?>
    </div>

    <script>
        function initGardenGallery(dataVarName) {
            return {
                activeItem: 0,
                itemCount: 0,
                fullscreen: false,
                loop: true,
                isStart: true,
                isEnd: false,
                swipeStart: 0,
                swipeDir: "x",
                images: window[dataVarName] || [],
                thumbsOverflow: false,
                thumbsStart: true,
                thumbsEnd: true,

                init() {
                    this.itemCount = this.images.length;
                    this.initActive();
                    this.$watch('activeItem', (item) => {
                        this.isStart = this.activeItem === 0;
                        this.isEnd = this.activeItem === (this.itemCount - 1);

                        this.$nextTick(() => {
                            const activeThumb = this.getActiveThumb();
                            if (activeThumb) {
                                this.scrollTo(activeThumb);
                            };
                        });
                    });
                    this.$watch('itemCount', () => {
                        this.calcThumbsOverflow()
                    });
                    this.$watch('fullscreen', (open) => {
                        this.$nextTick(() => {
                            this.scrollLock(open);
                            this.tabLock(this.$refs.galleryDialog, open);
                        })
                    })
                },
                getImage(image) {
                    return this.fullscreen ? image.full : image.img;
                },
                isActive(index) {
                    return this.activeItem === index;
                },
                scrollLock(use = true) {
                    document.body.style.overflow = use ? "hidden" : "";
                },
                tabLock(target, use = true) {
                    if (use) {
                        hyva.trapFocus(target);
                    } else {
                        hyva.releaseFocus(target);
                    }
                },
                nextItem() {
                    const hasNext = this.activeItem < (this.itemCount - 1);
                    this.activeItem = hasNext
                        ? this.activeItem += 1
                        : this.loop ? 0 : this.activeItem;
                },
                prevItem() {
                    const hasPrev = this.activeItem > 0;
                    this.activeItem = hasPrev
                        ? this.activeItem -= 1
                        : this.loop ? (this.itemCount - 1) : this.activeItem;
                },
                swipeItem(event) {
                    if (this.swipeStart === 0) return;

                    const swipeEnd = this.getTouchPosition(event);
                    if (Math.abs((swipeEnd - this.swipeStart)) < 40) return;

                    if (this.swipeStart > swipeEnd) {
                        this.nextItem();
                    } else {
                        this.prevItem();
                    }

                    this.swipeStart = 0;
                },
                getTouchPosition(event) {
                    const position = this.swipeDir === "y"
                        ? event.changedTouches[0].clientY
                        : event.changedTouches[0].clientX;
                    return Math.round(position);
                },
                isSwipeGesture(event) {
                    return event.touches.length <= 1 && window.visualViewport.scale <= 1.01;
                },
                initActive() {
                    const mainImg = this.images.findIndex(image => image.isMain === true);
                    this.activeItem = mainImg === -1 ? 0 : mainImg;
                    this.isStart = this.activeItem === 0;
                    this.isEnd = this.activeItem === (this.itemCount - 1);
                },
                eventListeners: {
                    ['@keydown.window.escape']() {
                        this.fullscreen = false;
                    }
                },
                galleryBody: {
                    ['@touchstart.passive'](event) {
                        this.swipeStart = this.isSwipeGesture(event)
                            ? this.getTouchPosition(event)
                            : 0;
                    },
                    ['@touchend.passive'](event) {
                        if (!this.isSwipeGesture(event)) return;
                        this.swipeItem(event);
                    },
                },
                galleryThumbs: {
                    ['x-init']() {
                        this.$nextTick(() => this.calcThumbsOverflow());
                    },
                    ['@resize.window.debounce']() {
                        this.calcThumbsOverflow();
                    }
                },
                galleryClasses() {
                    return {
                        'z-50 fixed inset-0 w-screen h-screen bg-white': this.fullscreen,
                        'relative': !this.fullscreen
                    }
                },
                firstImageClasses() {
                    return 'invisible';
                },
                imageWrapperFullscreenClasses() {
                    return { 'p-4 sm:p-8 pb-24': this.fullscreen };
                },
                imageFullscreenClasses() {
                    return { 'w-auto h-auto max-w-full max-h-full': this.fullscreen };
                },
                hasMultipleImages() {
                    return this.images.length > 1;
                },
                isAtStart() {
                    return !this.loop && this.isStart;
                },
                isAtEnd() {
                    return !this.loop && this.isEnd;
                },
                notFullscreen() {
                    return !this.fullscreen;
                },
                openFullscreen() {
                    this.fullscreen = true;
                },
                closeFullscreen() {
                    this.fullscreen = false;
                },
                fullscreenRole() {
                    return this.fullscreen ? 'dialog' : false;
                },
                fullscreenLabel() {
                    return this.fullscreen ? '<?= $escaper->escapeJs(__('Fullscreen Gallery')) ?>' : false;
                },
                maskOverflowClasses() {
                    const noMask = 'mask-overflow-start mask-overflow-end';
                    const sliderMask = {
                        'mask-overflow-end': this.thumbsStart,
                        'mask-overflow-start': this.thumbsEnd
                    };

                    return this.thumbsOverflow ? sliderMask : noMask;
                },
                scrollTo(target) {
                    target.scrollIntoView({
                        behavior: "smooth",
                        block: "nearest",
                        inline: "nearest"
                    });
                },
                thumbIsActive(index) {
                    return this.activeItem === index;
                },
                setThumbActive(index) {
                    return this.activeItem = index;
                },
                thumbClasses(index) {
                    return {
                        'border-primary group-focus:border-gray-400': this.activeItem === index,
                        'border-transparent': this.activeItem !== index
                    }
                },
                getActiveThumb() {
                    return this.$refs.jsThumbSlides.querySelector('button[aria-current="true"]');
                },
                isThumbInView(index, action = "leave") {
                    const isFirst = index === 0;
                    const isLast = index === (this.itemCount - 1);

                    if (isFirst) {
                        this.thumbsStart = (action === "enter");
                    }

                    if (isLast) {
                        this.thumbsEnd = (action === "enter");
                    }
                },
                isThumbInViewEnter(index) {
                    this.isThumbInView(index, "enter")
                },
                isThumbInViewLeave(index) {
                    this.isThumbInView(index, "leave")
                },
                calcThumbsOverflow() {
                    const thumbs = this.$refs.jsThumbSlides;
                    if (!thumbs) return;

                    const { scrollWidth, scrollHeight, offsetWidth, offsetHeight } = thumbs;
                    const hasOverflow = scrollHeight > scrollWidth
                        ? scrollHeight > offsetHeight
                        : scrollWidth > offsetWidth;

                    this.thumbsOverflow = hasOverflow;
                }
            }
        }
        window.addEventListener('alpine:init', () => Alpine.data('initGardenGallery', initGardenGallery), {once: true})
    </script>
    <?php $hyvaCsp->registerInlineScript() ?>

<?php else: ?>
    <p class="text-center py-8"><?= $escaper->escapeHtml(__('There are no galleries to display.')) ?></p>
<?php endif; ?>
