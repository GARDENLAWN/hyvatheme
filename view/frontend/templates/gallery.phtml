<?php

declare(strict_types=1);

use GardenLawn\Core\ViewModel\Gallery;
use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\HyvaCsp;
use Hyva\Theme\ViewModel\HeroiconsOutline;
use Hyva\Theme\ViewModel\HeroiconsSolid;
use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;
use Magento\Framework\Serialize\Serializer\Json;

/** @var Template $block */
/** @var Escaper $escaper */
/** @var ViewModelRegistry $viewModels */
/** @var HyvaCsp $hyvaCsp */

$galleryViewModel = $viewModels->require(Gallery::class);
$worksInfo = $galleryViewModel->getWorksInfo();
$jsonSerializer = new Json();

$heroicons = $viewModels->require(HeroiconsOutline::class);
$heroiconsSolid = $viewModels->require(HeroiconsSolid::class);

// Pagination Logic
$page = (int) ($block->getRequest()->getParam('p') ?? 1);
$pageSize = 5;
$totalItems = count($worksInfo);
$totalPages = (int) ceil($totalItems / $pageSize);

if ($page < 1) {
    $page = 1;
}
if ($page > $totalPages && $totalPages > 0) {
    $page = $totalPages;
}

$offset = ($page - 1) * $pageSize;
$pagedWorksInfo = array_slice($worksInfo, $offset, $pageSize);

// Pass pagination data to the head block
$block->setData('total_pages', $totalPages);
$block->setData('current_page', $page);

?>

<?= $block->getChildHtml('head.additional') ?>

<?php if (!empty($pagedWorksInfo)): ?>
    <div class="container px-4 py-8 mx-auto space-y-16">
        <?php foreach ($pagedWorksInfo as $gallery): ?>
            <?php if (empty($gallery['images'])) continue; ?>
            <?php
                $galleryId = 'gallery-' . ($gallery['id'] ?? uniqid());
                // Use folder name (ID) as title
                $galleryTitle = $gallery['id'] ?? '';

                // Map images to the structure expected by the Hyva Gallery JS
                $mappedImages = array_map(function ($image) {
                    return [
                        'full' => $image['link'],
                        'img' => $image['link'],
                        'thumb' => $image['thumb'],
                        'caption' => '', // Empty caption as requested
                        'type' => 'image',
                        'isMain' => !empty($image['main']),
                        'videoUrl' => null
                    ];
                }, $gallery['images']);
            ?>

            <div class="w-full">
                <h2 class="mb-6 text-3xl font-bold text-center"><?= $escaper->escapeHtml($galleryTitle) ?></h2>

                <div x-data="viewFrontendTemplatesGalleryMovedScript0">
<?php /** Moved variables previously here to "./view/frontend/templates/gallery-csp-js.phtml" */ ?>
<?php /** References (`$galleryId`, `$jsonSerializer->serialize(...)`, `$mappedImages`) */ ?>
</div><section
                    id="<?= $escaper->escapeHtmlAttr($galleryId) ?>"
                    class="relative pb-[calc(90px+2rem)]"
                    style="
                        --gallery-ratio: 16/9;
                        --gallery-width: 100%;
                        --thumb-size: 90px;
                    "
                    aria-label="<?= $escaper->escapeHtmlAttr(__('%1 Gallery', $galleryTitle)) ?>"
                    x-data="gardenLawnHyvathemeGallery"
                    x-bind="eventListeners"
                >
                    <!-- Fullscreen Backdrop -->
                    <div
                        class="max-w-full w-[var(--gallery-width)] aspect-[var(--gallery-ratio)]"
                        aria-hidden="true"
                        x-show="fullscreen"
                        x-cloak
                    ></div>
                    <div
                        class="z-50 backdrop"
                        aria-hidden="true"
                        x-show="fullscreen"
                        x-transition.opacity
                        x-cloak
                        @click="closeFullscreen"
                    ></div>

                    <!-- Main Gallery Area -->
                    <div
                        class="relative overflow-hidden bg-white rounded-lg aspect-[var(--gallery-ratio)]"
                        aria-live="polite"
                        aria-atomic="true"
                        x-bind="galleryBody"
                        x-ref="galleryDialog"
                        :class="gardenLawnHyvathemeGalleryClass1"
                        :role="gardenLawnHyvathemeGalleryRole2"
                        :aria-modal="fullscreen"
                        :aria-label="gardenLawnHyvathemeGalleryAriaLabel3"
                        @keyup.arrow-right="nextItem"
                        @keyup.arrow-left="prevItem"
                    >
                        <!-- Placeholder / First Image -->
                        <figure class="flex flex-col items-center justify-center h-full" :class="gardenLawnHyvathemeGalleryClass4">
                            <img
                                src="<?= $escaper->escapeUrl($mappedImages[0]['img']) ?>"
                                alt=""
                                class="object-contain max-w-full max-h-full"
                                loading="eager"
                            >
                        </figure>

                        <!-- Images Loop -->
                        <template x-for="(image, index) in images" :key="index">
                            <figure
                                class="absolute inset-0 flex flex-col"
                                :class="gardenLawnHyvathemeGalleryClass5"
                                x-show="gardenLawnHyvathemeGalleryShow6"
                                x-transition:enter.opacity.duration.500ms
                                x-transition:leave.opacity.duration.0ms
                            >
                                <img
                                    class="max-w-full max-h-full m-auto object-contain"
                                    :class="gardenLawnHyvathemeGalleryClass7"
                                    :src="gardenLawnHyvathemeGallerySrc8"
                                    alt=""
                                >
                            </figure>
                        </template>

                        <!-- Controls -->
                        <div class="z-0 absolute inset-0 p-2 w-full flex flex-col justify-start items-end gap-2" x-cloak>
                            <button
                                class="p-2 rounded-full transition shadow hover:shadow-primary/30 focus:shadow-primary/30 bg-white text-primary"
                                title="<?= $escaper->escapeHtmlAttr(__('Close fullscreen')) ?>"
                                aria-label="<?= $escaper->escapeHtmlAttr(__('Close fullscreen')) ?>"
                                x-show="fullscreen"
                                @click="closeFullscreen"
                            >
                                <?= $heroicons->xHtml('', 24, 24, ['aria-hidden' => 'true']); ?>
                            </button>
                            <button
                                aria-label="<?= $escaper->escapeHtmlAttr(__('Open fullscreen')) ?>"
                                tabindex="-1"
                                x-show="gardenLawnHyvathemeGalleryShow9"
                                @click="openFullscreen"
                                class="absolute inset-0 w-full -z-10"
                            >
                                <span
                                    title="<?= $escaper->escapeHtmlAttr(__('Open fullscreen')) ?>"
                                    class="block p-2 rounded-full transition shadow hover:shadow-primary/30 focus:shadow-primary/30 bg-white text-primary/50 hover:text-primary focus:text-primary absolute top-2 right-2 z-20"
                                >
                                    <?= $heroicons->arrowsExpandHtml('', 24, 24, ['aria-hidden' => 'true']); ?>
                                </span>
                            </button>
                        </div>

                        <!-- Navigation Arrows -->
                        <nav
                            class="z-10 absolute bottom-2 lg:bottom-4 xl:bottom-8 flex justify-between gap-2 left-2 lg:left-4 xl:left-8 right-2 lg:right-4 xl:right-8"
                            aria-label="<?= $escaper->escapeHtmlAttr(__('%1 Gallery Navigation', $galleryTitle)) ?>"
                            x-show="gardenLawnHyvathemeGalleryShow10"
                            x-cloak
                        >
                            <button
                                type="button"
                                tabindex="-1"
                                class="shrink-0 p-1.5 md:p-0 disabled:opacity-30"
                                title="<?= $escaper->escapeHtmlAttr(__('Previous')) ?>"
                                aria-label="<?= $escaper->escapeHtmlAttr(__('Previous')) ?>"
                                :disabled="gardenLawnHyvathemeGalleryDisabled11"
                                @click="prevItem"
                            >
                                <span class="block p-2.5 rounded-full transition shadow hover:shadow-primary/30 focus:shadow-primary/30 bg-white text-primary">
                                    <?= $heroiconsSolid->arrowLeftHtml('', 16, 16, ['aria-hidden' => 'true']) ?>
                                </span>
                            </button>
                            <button
                                type="button"
                                tabindex="-1"
                                class="shrink-0 p-1.5 md:p-0 disabled:opacity-30"
                                title="<?= $escaper->escapeHtmlAttr(__('Next')) ?>"
                                aria-label="<?= $escaper->escapeHtmlAttr(__('Next')) ?>"
                                :disabled="gardenLawnHyvathemeGalleryDisabled12"
                                @click="nextItem"
                            >
                                <span class="block p-2.5 rounded-full transition shadow hover:shadow-primary/30 focus:shadow-primary/30 bg-white text-primary">
                                    <?= $heroiconsSolid->arrowRightHtml('', 16, 16, ['aria-hidden' => 'true']) ?>
                                </span>
                            </button>
                        </nav>
                    </div>

                    <!-- Thumbnails -->
                    <div
                        class="flex items-center gap-2 outline-0 absolute inset-x-0 bottom-0 h-[var(--thumb-size)]"
                        x-bind="galleryThumbs"
                        x-show="gardenLawnHyvathemeGalleryShow10"
                        x-cloak
                    >
                        <button
                            type="button"
                            class="shrink-0 flex justify-center items-center backdrop-blur bg-white/30 disabled:opacity-30 z-10 absolute left-0 inset-y-0 p-2 h-full"
                            tabindex="-1"
                            :disabled="gardenLawnHyvathemeGalleryDisabled11"
                            @click="prevItem"
                            x-show="thumbsOverflow"
                            x-cloak
                        >
                            <?= $heroicons->chevronLeftHtml() ?>
                        </button>

                        <nav
                            class="group flex snap overflow-auto overscroll-contain gap-2 outline-none mask-overflow h-full items-center"
                            tabindex="0"
                            :class="gardenLawnHyvathemeGalleryClass15"
                            x-ref="jsThumbSlides"
                            @keyup.arrow-right="nextItem"
                            @keyup.arrow-left="prevItem"
                            aria-label="<?= $escaper->escapeHtmlAttr(__('%1 Gallery Thumbnails', $galleryTitle)) ?>"
                        >
                            <template x-for="(image, index) in images" :key="index">
                                <button
                                    type="button"
                                    class="relative shrink-0 border-2 border-transparent w-[90px] h-[90px] flex items-center justify-center overflow-hidden bg-gray-100"
                                    tabindex="-1"
                                    :class="gardenLawnHyvathemeGalleryClass16"
                                    :aria-label="gardenLawnHyvathemeGalleryAriaLabel17" data-hyvacsp1="<?= $escaper->escapeHtmlAttr(__('View image')) ?>"
                                    :aria-current="gardenLawnHyvathemeGalleryAriaCurrent18"
                                    x-intersect:enter.full="gardenLawnHyvathemeGalleryEnterFull19"
                                    x-intersect:leave.full="gardenLawnHyvathemeGalleryLeaveFull20"
                                    @click="gardenLawnHyvathemeGalleryClick21"
                                >
                                    <img
                                        :src="gardenLawnHyvathemeGallerySrc22"
                                        alt=""
                                        class="max-w-full max-h-full object-contain"
                                        loading="lazy"
                                    >
                                </button>
                            </template>
                        </nav>

                        <button
                            type="button"
                            class="shrink-0 flex justify-center items-center backdrop-blur bg-white/30 disabled:opacity-30 z-10 absolute right-0 inset-y-0 p-1 h-full"
                            tabindex="-1"
                            :disabled="gardenLawnHyvathemeGalleryDisabled12"
                            @click="nextItem"
                            x-show="thumbsOverflow"
                            x-cloak
                        >
                            <?= $heroicons->chevronRightHtml() ?>
                        </button>
                    </div>
                </section>
            </div>
        <?php endforeach; ?>

        <!-- Pagination Controls -->
        <?php if ($totalPages > 1): ?>
            <div class="flex justify-center items-center space-x-2 mt-8">
                <?php if ($page > 1): ?>
                    <a href="?p=<?= $page - 1 ?>" class="px-4 py-2 bg-white border rounded hover:bg-gray-100">
                        <?= $heroicons->chevronLeftHtml('', 20, 20) ?>
                    </a>
                <?php endif; ?>

                <?php for ($i = 1; $i <= $totalPages; $i++): ?>
                    <a href="?p=<?= $i ?>" class="px-4 py-2 border rounded <?= $i === $page ? 'bg-primary text-white border-primary' : 'bg-white hover:bg-gray-100' ?>">
                        <?= $i ?>
                    </a>
                <?php endfor; ?>

                <?php if ($page < $totalPages): ?>
                    <a href="?p=<?= $page + 1 ?>" class="px-4 py-2 bg-white border rounded hover:bg-gray-100">
                        <?= $heroicons->chevronRightHtml('', 20, 20) ?>
                    </a>
                <?php endif; ?>
            </div>
        <?php endif; ?>
    </div>

    <?php $hyvaCsp->registerInlineScript() ?>

<?php else: ?>
    <p class="text-center py-8"><?= $escaper->escapeHtml(__('There are no galleries to display.')) ?></p>
<?php endif; ?>
<div x-data="viewFrontendTemplatesGalleryMovedScript1">
<?php /** Moved variables previously here to "./view/frontend/templates/gallery-csp-js.phtml" */ ?>
<?php /** References (`$galleryId`) */ ?>
</div>